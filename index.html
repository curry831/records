<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è€ƒç ”çŸ¥è¯†ç‚¹è®°å½•æœ¬ - å¤§æ•°æ®ç‰ˆ</title>
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* åŸºç¡€æ ·å¼é‡ç½® */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Noto Sans SC', sans-serif;
    background-color: #f8fafc;
    color: #1e293b;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* å®¹å™¨æ ·å¼ */
.container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 1rem;
}

@media (min-width: 640px) {
    .container {
        padding: 0 1.5rem;
    }
}

/* ç™»å½•å®¹å™¨ */
.login-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    z-index: 1000;
}

.login-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    padding: 2rem;
    width: 100%;
    max-width: 28rem;
    margin: 1rem;
}

/* åº”ç”¨å®¹å™¨ */
.app-container {
    display: none;
    min-height: 100vh;
    background-color: #f8fafc;
}

/* è¡¨å•æ ·å¼ */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.25rem;
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 1rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    background-color: white;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 6rem;
}

/* æŒ‰é’®æ ·å¼ */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

.btn-primary {
    background-color: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background-color: #2563eb;
}

.btn-secondary {
    background-color: #10b981;
    color: white;
}

.btn-secondary:hover {
    background-color: #059669;
}

.btn-danger {
    background-color: #ef4444;
    color: white;
}

.btn-danger:hover {
    background-color: #dc2626;
}

.btn-warning {
    background-color: #f59e0b;
    color: white;
}

.btn-warning:hover {
    background-color: #d97706;
}

.btn-full {
    width: 100%;
}

/* å¡ç‰‡æ ·å¼ */
.card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

/* çŸ¥è¯†ç‚¹é¡¹æ ·å¼ */
.knowledge-item {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: box-shadow 0.15s ease-in-out, transform 0.15s ease-in-out;
}

.knowledge-item:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(-2px);
}

.knowledge-item.mastered {
    background-color: #f0fdf4;
    border-color: #22c55e;
}

.knowledge-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.knowledge-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1e40af;
    word-wrap: break-word;
    flex-grow: 1;
    margin-right: 1rem;
}

.knowledge-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.knowledge-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.25rem;
    transition: transform 0.15s ease-in-out;
}

.knowledge-btn:hover {
    transform: scale(1.1);
}

.knowledge-detail {
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 0.5rem;
}

.knowledge-content {
    font-size: 1rem;
    color: #334155;
    line-height: 1.7;
    margin-bottom: 0.75rem;
    white-space: pre-wrap;
}

.knowledge-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.5rem;
}

.knowledge-tag {
    display: inline-block;
    background-color: #e0e7ff;
    color: #3730a3;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
}

/* ç»Ÿè®¡å¡ç‰‡ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

@media (min-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.stat-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    padding: 1rem;
    text-align: center;
}

.stat-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
}

/* å¤´éƒ¨æ ·å¼ */
.header {
    background: white;
    border-bottom: 1px solid #e2e8f0;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.user-name {
    font-weight: 500;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.header-btn {
    background: none;
    border: none;
    color: #3b82f6;
    cursor: pointer;
    font-size: 0.875rem;
    text-decoration: none;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    transition: all 0.15s ease-in-out;
}

.header-btn:hover {
    color: #2563eb;
    background-color: #f1f5f9;
}

.header-btn.danger {
    color: #ef4444;
}

.header-btn.danger:hover {
    color: #dc2626;
    background-color: #fef2f2;
}

.header-btn.warning {
    color: #f59e0b;
}

.header-btn.warning:hover {
    color: #d97706;
    background-color: #fffbeb;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    padding: 1.5rem;
    width: 100%;
    max-width: 32rem;
    max-height: 80vh;
    overflow-y: auto;
    margin: 1rem;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 700;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
}

.modal-close:hover {
    color: #374151;
}

/* åŠ è½½åŠ¨ç”» */
.loading {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #f3f4f6;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* æç¤ºæ¶ˆæ¯ */
.toast {
    position: fixed;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background-color: #10b981;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.375rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    opacity: 0;
    transition: all 0.3s ease-in-out;
    z-index: 2000;
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* åŒæ­¥çŠ¶æ€ */
.sync-status {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    display: none;
    z-index: 1000;
    max-width: 300px;
    text-align: center;
    line-height: 1.4;
}

.sync-status.show {
    display: block;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 640px) {
    .modal-content {
        margin: 0.5rem;
        max-height: 90vh;
    }
    
    .knowledge-header {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .knowledge-actions {
        align-self: flex-end;
    }
    
    .header-actions {
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .header-btn {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
    }
}

/* åŠ¨ç”»æ•ˆæœ */
.fade-in {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* æ–‡ä»¶æ‹–æ”¾åŒºåŸŸ */
.file-drop {
    border: 2px dashed #d1d5db;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

.file-drop:hover {
    border-color: #3b82f6;
    background-color: #f8fafc;
}

.file-drop.dragover {
    border-color: #3b82f6;
    background-color: #eff6ff;
}

/* é”™è¯¯æ¶ˆæ¯ */
.error-message {
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: #fef2f2;
    border-radius: 0.25rem;
    display: none;
}

.error-message.show {
    display: block;
}

/* è¡¨æ ¼æ ·å¼ */
.table-container {
    max-height: 300px;
    overflow-y: auto;
    margin: 1rem 0;
}

.table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.table th,
.table td {
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    text-align: left;
}

.table th {
    background-color: #f9fafb;
    position: sticky;
    top: 0;
}

.table tr:nth-child(even) {
    background-color: #f9fafb;
}

.table tr:hover {
    background-color: #f3f4f6;
}

/* ç­›é€‰å™¨æ ·å¼ */
.filter-section {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    padding: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.filter-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    white-space: nowrap;
}

.filter-select {
    flex-grow: 1;
}

.clear-filter-btn {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    font-size: 0.875rem;
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: all 0.15s ease-in-out;
}

.clear-filter-btn:hover {
    background-color: #f3f4f6;
    color: #374151;
}

@media (max-width: 640px) {
    .filter-section {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-label {
        margin-bottom: 0.5rem;
    }
    
    .clear-filter-btn {
        align-self: flex-end;
        margin-top: 0.5rem;
    }
}

/* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
.image-upload-container {
    margin-bottom: 1rem;
}

.image-upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    background-color: #f9fafb;
}

.image-upload-area:hover {
    border-color: #3b82f6;
    background-color: #eff6ff;
}

.image-upload-area.dragover {
    border-color: #3b82f6;
    background-color: #eff6ff;
}

.image-upload-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.clipboard-btn {
    background-color: #8b5cf6;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.clipboard-btn:hover {
    background-color: #7c3aed;
}

.clipboard-btn:disabled {
    background-color: #d1d5db;
    cursor: not-allowed;
}

.image-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.image-preview {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 0.375rem;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-preview-remove {
    position: absolute;
    top: 0;
    right: 0;
    background-color: rgba(239, 68, 68, 0.8);
    color: white;
    border: none;
    border-radius: 0 0 0 0.375rem;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

/* çŸ¥è¯†ç‚¹ä¸­çš„å›¾ç‰‡æ ·å¼ */
.knowledge-images {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 0.75rem 0;
}

.knowledge-image {
    width: 100px;
    height: 100px;
    border-radius: 0.375rem;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    cursor: pointer;
    transition: transform 0.15s ease-in-out;
}

.knowledge-image:hover {
    transform: scale(1.05);
}

.knowledge-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
.image-preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 1rem;
}

.image-preview-modal.show {
    display: flex;
}

.image-preview-content {
    max-width: 90%;
    max-height: 90%;
    position: relative;
}

.image-preview-content img {
    max-width: 100%;
    max-height: 100%;
    border-radius: 0.5rem;
}

.image-preview-close {
    position: absolute;
    top: -40px;
    right: 0;
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    line-height: 1;
}

.image-preview-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.image-preview-nav.prev {
    left: -60px;
}

.image-preview-nav.next {
    right: -60px;
}

.image-preview-counter {
    position: absolute;
    bottom: -40px;
    left: 0;
    right: 0;
    text-align: center;
    color: white;
    font-size: 0.875rem;
}

@media (max-width: 640px) {
    .image-preview-nav.prev {
        left: 10px;
    }
    
    .image-preview-nav.next {
        right: 10px;
    }
    
    .image-preview-close {
        top: 10px;
        right: 10px;
    }
}

/* æ•°æ®ç®¡ç†é¢æ¿æ ·å¼ */
.data-management {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.data-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.data-item {
    text-align: center;
    padding: 0.5rem;
    background: white;
    border-radius: 0.375rem;
    border: 1px solid #e5e7eb;
}

.data-item-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
}

.data-item-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.25rem;
}

.data-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.progress-bar {
    width: 100%;
    height: 0.5rem;
    background: #e5e7eb;
    border-radius: 0.25rem;
    overflow: hidden;
    margin: 0.5rem 0;
}

.progress-fill {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s ease;
}
</style>
</head>
<body>
<!-- åŠ è½½é®ç½© -->
<div id="loading-overlay" class="loading-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; z-index: 9999;">
    <div style="text-align: center;">
        <div class="loading"></div>
        <p style="margin-top: 0.5rem; color: #374151;">æ­£åœ¨åˆå§‹åŒ–åº”ç”¨...</p>
        <p id="loading-status" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;"></p>
    </div>
</div>

<!-- ç™»å½•ç•Œé¢ -->
<div id="login-container" class="login-container">
    <div class="login-card">
        <h2 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem;">ğŸ“ è€ƒç ”çŸ¥è¯†ç‚¹è®°å½•æœ¬ - å¤§æ•°æ®ç‰ˆ</h2>
        
        <form id="login-form">
            <div class="form-group">
                <label for="username" class="form-label">ç”¨æˆ·å</label>
                <input type="text" id="username" class="form-input" placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·å" required>
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">å¯†ç </label>
                <input type="password" id="password" class="form-input" placeholder="è¾“å…¥æ‚¨çš„å¯†ç " required>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; font-size: 0.875rem; color: #64748b;">
                    <input type="checkbox" id="use-local" style="margin-right: 0.5rem;">
                    ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
                </label>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" id="login-btn">
                <span id="login-text">ç™»å½•</span>
                <div id="login-spinner" class="loading" style="display: none; margin-left: 0.5rem;"></div>
            </button>
            
            <p style="text-align: center; font-size: 0.875rem; color: #64748b; margin-top: 1rem;">
                é¦–æ¬¡ä½¿ç”¨å°†è‡ªåŠ¨åˆ›å»ºè´¦æˆ·
            </p>
        </form>
    </div>
</div>

<!-- ä¸»åº”ç”¨ç•Œé¢ -->
<div id="app-container" class="app-container">
    <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="user-info">
                    <span>ç”¨æˆ·:</span>
                    <span id="current-user" class="user-name"></span>
                </div>
                <div class="header-actions">
                    <button id="data-management-btn" class="header-btn warning">ğŸ“Š æ•°æ®ç®¡ç†</button>
                    <button id="cleanup-btn" class="header-btn warning">ğŸ§¹ æ¸…ç†</button>
                    <button id="backup-btn" class="header-btn">ğŸ’¾ å¤‡ä»½</button>
                    <button id="sync-btn" class="header-btn">
                        <div id="sync-spinner" class="loading" style="display: none; margin-right: 0.25rem;"></div>
                        <span id="sync-text">æ™ºèƒ½åŒæ­¥</span>
                    </button>
                    <button id="logout-btn" class="header-btn danger">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container" style="padding-top: 1.5rem; padding-bottom: 3rem;">
        <!-- æ ‡é¢˜ -->
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1 style="font-size: 2rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">ğŸ“ è€ƒç ”çŸ¥è¯†ç‚¹è®°å½•æœ¬</h1>
            <p style="color: #64748b;">é«˜æ•ˆè®°å½•ï¼Œç³»ç»Ÿå¤ä¹ ï¼ŒæˆåŠŸä¸Šå²¸ - æ”¯æŒå¤§æ•°æ®å­˜å‚¨</p>
        </div>

        <!-- æ•°æ®ç®¡ç†é¢æ¿ -->
        <div id="data-management-panel" class="data-management" style="display: none;">
            <h3 style="font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">ğŸ“Š æ•°æ®ç®¡ç†</h3>
            
            <div class="data-info">
                <div class="data-item">
                    <div class="data-item-value" id="total-size">0 MB</div>
                    <div class="data-item-label">æ€»æ•°æ®å¤§å°</div>
                </div>
                <div class="data-item">
                    <div class="data-item-value" id="total-knowledge">0</div>
                    <div class="data-item-label">çŸ¥è¯†ç‚¹æ€»æ•°</div>
                </div>
                <div class="data-item">
                    <div class="data-item-value" id="total-images">0</div>
                    <div class="data-item-label">å›¾ç‰‡æ€»æ•°</div>
                </div>
                <div class="data-item">
                    <div class="data-item-value" id="total-dates">0</div>
                    <div class="data-item-label">å­¦ä¹ å¤©æ•°</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="storage-progress" style="width: 0%"></div>
            </div>
            
            <div class="data-actions">
                <button id="analyze-btn" class="btn btn-secondary">ğŸ” åˆ†ææ•°æ®</button>
                <button id="clean-large-btn" class="btn btn-warning">ğŸ§¹ æ¸…ç†å¤§å›¾ç‰‡</button>
                <button id="optimize-btn" class="btn btn-primary">âš¡ ä¼˜åŒ–å­˜å‚¨</button>
                <button id="export-backup-btn" class="btn btn-secondary">ğŸ’¾ å¯¼å‡ºå¤‡ä»½</button>
            </div>
        </div>

        <!-- æ·»åŠ çŸ¥è¯†ç‚¹è¡¨å• -->
        <section class="card">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">æ·»åŠ æ–°çŸ¥è¯†ç‚¹</h2>
            
            <form id="knowledge-form">
                <div class="form-group">
                    <label for="subject-select" class="form-label">å­¦ç§‘</label>
                    <select id="subject-select" class="form-select" required>
                        <option value="" disabled selected>è¯·é€‰æ‹©å­¦ç§‘</option>
                        <option value="è‹±è¯­">è‹±è¯­</option>
                        <option value="æ”¿æ²»">æ”¿æ²»</option>
                        <option value="æ•°å­¦">æ•°å­¦</option>
                        <option value="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</option>
                        <option value="è®¡ç®—æœºæ“ä½œç³»ç»Ÿ">è®¡ç®—æœºæ“ä½œç³»ç»Ÿ</option>
                        <option value="è®¡ç®—æœºç½‘ç»œ">è®¡ç®—æœºç½‘ç»œ</option>
                        <option value="è®¡ç®—æœºç»„æˆåŸç†">è®¡ç®—æœºç»„æˆåŸç†</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="title-input" id="title-label" class="form-label">çŸ¥è¯†ç‚¹åç§°/é¢˜ç›®</label>
                    <input type="text" id="title-input" class="form-input" placeholder="ä¾‹å¦‚ï¼šå¿«é€Ÿæ’åºç®—æ³• / æ¯›æ³½ä¸œæ€æƒ³æ´»çš„çµé­‚" required>
                </div>
                
                <div class="form-group">
                    <label for="content-input" id="content-label" class="form-label">çŸ¥è¯†ç‚¹å†…å®¹/è§£é¢˜æ€è·¯</label>
                    <textarea id="content-input" class="form-textarea" placeholder="è¯¦ç»†è®°å½•çŸ¥è¯†ç‚¹ã€å…¬å¼ã€è§£é¢˜æ­¥éª¤æˆ–æ€è·¯..." required></textarea>
                </div>
                
                <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                <div class="form-group image-upload-container">
                    <label class="form-label">ç›¸å…³å›¾ç‰‡</label>
                    
                    <!-- ä¸Šä¼ æ§åˆ¶æŒ‰é’® -->
                    <div class="image-upload-controls">
                        <button type="button" class="clipboard-btn" id="clipboard-btn">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            ä»å‰ªåˆ‡æ¿ç²˜è´´
                        </button>
                    </div>
                    
                    <div class="image-upload-area" id="image-upload-area">
                        <input type="file" id="image-input" accept="image/*" multiple style="display: none;">
                        <div style="color: #64748b;">
                            <svg style="width: 2rem; height: 2rem; margin: 0 auto 0.5rem; color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p style="font-size: 0.875rem;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                            <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤šä¸Šä¼ 5å¼ </p>
                            <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">æˆ–ä½¿ç”¨ Ctrl+V ç²˜è´´å›¾ç‰‡</p>
                        </div>
                    </div>
                    <div class="image-preview-container" id="image-preview-container"></div>
                </div>
                
                <div class="form-group">
                    <label for="tags-input" class="form-label">æ ‡ç­¾</label>
                    <input type="text" id="tags-input" class="form-input" placeholder="æ·»åŠ æ ‡ç­¾ï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼ˆå¦‚ï¼šæ’åºç®—æ³• ç¬¬ä¸€ç«  é‡ç‚¹ï¼‰">
                </div>
                
                <button type="submit" class="btn btn-primary btn-full">è®°å½•çŸ¥è¯†ç‚¹</button>
            </form>
        </section>

        <!-- å¯¼å…¥å¯¼å‡º -->
        <section style="margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <button id="export-trigger-btn" class="btn btn-secondary">ğŸ“Š å¯¼å‡ºä¸ºExcel</button>
                <button id="import-trigger-btn" class="btn btn-primary">ğŸ“¥ å¯¼å…¥Excelæ–‡ä»¶</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">æ€»çŸ¥è¯†ç‚¹æ•°</div>
                    <div id="total-knowledge" class="stat-value" style="color: #3b82f6;">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å­¦ä¹ å¤©æ•°</div>
                    <div id="study-days" class="stat-value" style="color: #10b981;">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥å¤ä¹ </div>
                    <div id="today-knowledge" class="stat-value" style="color: #f59e0b;">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å·²æŒæ¡</div>
                    <div id="mastered-knowledge" class="stat-value" style="color: #22c55e;">0</div>
                </div>
            </div>
        </section>

        <!-- å­¦ç§‘ç­›é€‰å™¨ -->
        <section class="filter-section">
            <label for="filter-subject-select" class="filter-label">ç­›é€‰å­¦ç§‘:</label>
            <select id="filter-subject-select" class="form-select filter-select">
                <option value="">å…¨éƒ¨å­¦ç§‘</option>
                <option value="è‹±è¯­">è‹±è¯­</option>
                <option value="æ”¿æ²»">æ”¿æ²»</option>
                <option value="æ•°å­¦">æ•°å­¦</option>
                <option value="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</option>
                <option value="è®¡ç®—æœºæ“ä½œç³»ç»Ÿ">è®¡ç®—æœºæ“ä½œç³»ç»Ÿ</option>
                <option value="è®¡ç®—æœºç½‘ç»œ">è®¡ç®—æœºç½‘ç»œ</option>
                <option value="è®¡ç®—æœºç»„æˆåŸç†">è®¡ç®—æœºç»„æˆåŸç†</option>
            </select>
            <button id="clear-filter-btn" class="clear-filter-btn">æ¸…é™¤ç­›é€‰</button>
        </section>

        <!-- çŸ¥è¯†ç‚¹åˆ—è¡¨ -->
        <section id="knowledge-list-container">
            <!-- çŸ¥è¯†ç‚¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
        </section>
    </div>
</div>

<!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
<div id="export-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">é€‰æ‹©å¯¼å‡ºå†…å®¹</h3>
            <button class="modal-close" id="close-modal-btn">&times;</button>
        </div>
        <div id="export-options">
            <!-- é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- å¯¼å…¥æ¨¡æ€æ¡† -->
<div id="import-modal" class="modal">
    <div class="modal-content" style="max-width: 42rem;">
        <div class="modal-header">
            <h3 class="modal-title">å¯¼å…¥Excelæ–‡ä»¶</h3>
            <button class="modal-close" id="close-import-modal-btn">&times;</button>
        </div>
        
        <div class="file-drop" id="file-drop-zone">
            <input type="file" id="import-file-input" accept=".xlsx,.xls" style="display: none;">
            <div style="color: #64748b;">
                <svg style="width: 3rem; height: 3rem; margin: 0 auto 0.75rem; color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p style="font-size: 0.875rem;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„</p>
                <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
            </div>
        </div>
        
        <div id="import-error" class="error-message"></div>
        
        <div style="margin-bottom: 1rem;">
            <h4 style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">å¯¼å…¥é€‰é¡¹</h4>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                    <input type="radio" name="import-option" value="merge" checked style="margin-right: 0.5rem;">
                    åˆå¹¶å¯¼å…¥ï¼ˆä¿ç•™ç°æœ‰æ•°æ®ï¼Œè·³è¿‡é‡å¤çŸ¥è¯†ç‚¹ï¼‰
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                    <input type="radio" name="import-option" value="replace" style="margin-right: 0.5rem;">
                    æ›¿æ¢å¯¼å…¥ï¼ˆåˆ é™¤ç°æœ‰æ•°æ®ï¼Œå®Œå…¨æ›¿æ¢ï¼‰
                </label>
            </div>
        </div>
        
        <div id="import-preview" style="display: none;">
            <h4 style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">æ•°æ®é¢„è§ˆ</h4>
            <div class="table-container">
                <table class="table" id="preview-table">
                    <!-- é¢„è§ˆæ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </table>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                <p id="import-summary" style="font-size: 0.875rem; color: #64748b;"></p>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="cancel-import-btn" class="btn" style="background-color: #e5e7eb; color: #374151;">å–æ¶ˆ</button>
                    <button id="confirm-import-btn" class="btn btn-primary">ç¡®è®¤å¯¼å…¥</button>
                </div>
            </div>
        </div>
        
        <div id="import-status" style="display: none; text-align: center; padding: 1rem;">
            <div class="loading" style="margin: 0 auto 0.5rem;"></div>
            <p style="font-size: 0.875rem; color: #64748b;">æ­£åœ¨å¯¼å…¥æ•°æ®...</p>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘çŸ¥è¯†ç‚¹æ¨¡æ€æ¡† -->
<div id="edit-modal" class="modal">
    <div class="modal-content" style="max-width: 42rem;">
        <div class="modal-header">
            <h3 class="modal-title">ç¼–è¾‘çŸ¥è¯†ç‚¹</h3>
            <button class="modal-close" id="close-edit-modal-btn">&times;</button>
        </div>
        
        <form id="edit-form">
            <div class="form-group">
                <label for="edit-subject-select" class="form-label">å­¦ç§‘</label>
                <select id="edit-subject-select" class="form-select" required>
                    <option value="è‹±è¯­">è‹±è¯­</option>
                    <option value="æ”¿æ²»">æ”¿æ²»</option>
                    <option value="æ•°å­¦">æ•°å­¦</option>
                    <option value="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</option>
                    <option value="è®¡ç®—æœºæ“ä½œç³»ç»Ÿ">è®¡ç®—æœºæ“ä½œç³»ç»Ÿ</option>
                    <option value="è®¡ç®—æœºç½‘ç»œ">è®¡ç®—æœºç½‘ç»œ</option>
                    <option value="è®¡ç®—æœºç»„æˆåŸç†">è®¡ç®—æœºç»„æˆåŸç†</option>
                </select>
            </div>

            <div class="form-group">
                <label for="edit-title-input" id="edit-title-label" class="form-label">çŸ¥è¯†ç‚¹åç§°/é¢˜ç›®</label>
                <input type="text" id="edit-title-input" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label for="edit-content-input" id="edit-content-label" class="form-label">çŸ¥è¯†ç‚¹å†…å®¹/è§£é¢˜æ€è·¯</label>
                <textarea id="edit-content-input" class="form-textarea" required></textarea>
            </div>
            
            <!-- ç¼–è¾‘å›¾ç‰‡åŒºåŸŸ -->
            <div class="form-group image-upload-container">
                <label class="form-label">ç›¸å…³å›¾ç‰‡</label>
                
                <!-- ä¸Šä¼ æ§åˆ¶æŒ‰é’® -->
                <div class="image-upload-controls">
                    <button type="button" class="clipboard-btn" id="edit-clipboard-btn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        ä»å‰ªåˆ‡æ¿ç²˜è´´
                    </button>
                </div>
                
                <div class="image-upload-area" id="edit-image-upload-area">
                    <input type="file" id="edit-image-input" accept="image/*" multiple style="display: none;">
                    <div style="color: #64748b;">
                        <svg style="width: 2rem; height: 2rem; margin: 0 auto 0.5rem; color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p style="font-size: 0.875rem;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                        <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤šä¸Šä¼ 5å¼ </p>
                        <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">æˆ–ä½¿ç”¨ Ctrl+V ç²˜è´´å›¾ç‰‡</p>
                    </div>
                </div>
                <div class="image-preview-container" id="edit-image-preview-container"></div>
            </div>
            
            <div class="form-group">
                <label for="edit-tags-input" class="form-label">æ ‡ç­¾</label>
                <input type="text" id="edit-tags-input" class="form-input" placeholder="æ·»åŠ æ ‡ç­¾ï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼ˆå¦‚ï¼šæ’åºç®—æ³• ç¬¬ä¸€ç«  é‡ç‚¹ï¼‰">
            </div>
            
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button type="button" id="cancel-edit-btn" class="btn" style="background-color: #e5e7eb; color: #374151;">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </form>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="image-preview-modal" class="image-preview-modal">
    <div class="image-preview-content">
        <button class="image-preview-close" id="image-preview-close">&times;</button>
        <button class="image-preview-nav prev" id="image-preview-prev">â€¹</button>
        <button class="image-preview-nav next" id="image-preview-next">â€º</button>
        <img id="image-preview-img" src="" alt="é¢„è§ˆå›¾ç‰‡">
        <div class="image-preview-counter" id="image-preview-counter">1 / 1</div>
    </div>
</div>

<!-- æç¤ºæ¶ˆæ¯ -->
<div id="encouragement-toast" class="toast">
    <span id="encouragement-text"></span>
</div>

<!-- åŒæ­¥çŠ¶æ€ -->
<div id="sync-status" class="sync-status">
    <span id="sync-status-text">åŒæ­¥ä¸­...</span>
</div>

<script>
// Firebase é…ç½®
const firebaseConfig = {
    apiKey: "AIzaSyBPLuMktx7vBuqmh6KzIyRlNHK4yh4j5OY",
    authDomain: "words-43d1b.firebaseapp.com",
    databaseURL: "https://words-43d1b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "words-43d1b",
    storageBucket: "words-43d1b.firebasestorage.app",
    messagingSenderId: "992209854334",
    appId: "1:992209854334:web:e862a34544b49a243e1d2f",
    measurementId: "G-982EDQG7X0"
};

// åº”ç”¨çŠ¶æ€
let database = null;
let firebaseAvailable = false;
let currentUser = null;
let knowledgeData = {};
let isOnline = navigator.onLine;
let useLocalMode = false;
let importData = null;
let currentFilterSubject = "";
let uploadedImages = [];
let currentPreviewImageIndex = 0;
let currentPreviewImages = [];
let editingKnowledge = null;
let editingDate = null;
let editingImages = [];

// æ•°æ®ç®¡ç†çŠ¶æ€
let dataManagementStats = {
    totalSize: 0,
    totalKnowledge: 0,
    totalImages: 0,
    totalDates: 0,
    lastAnalysis: null
};

// åŒæ­¥çŠ¶æ€
let syncInProgress = false;
let syncQueue = [];
let lastSyncTime = null;
let syncStrategy = 'direct'; // 'direct', 'batch', 'layered'

// åŠ è½½çŠ¶æ€ç®¡ç†
const loadingOverlay = document.getElementById('loading-overlay');
const loadingStatus = document.getElementById('loading-status');

function showLoading(message) {
    if (loadingStatus) {
        loadingStatus.textContent = message;
    }
}

function hideLoading() {
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

// ç®€åŒ–çš„åˆå§‹åŒ–å‡½æ•°
function initializeApp() {
    try {
        console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
        
        // å°è¯•åŠ è½½ Firebase SDK
        showLoading('æ­£åœ¨åŠ è½½ Firebase SDK...');
        
        // åˆ›å»ºè„šæœ¬æ ‡ç­¾åŠ è½½ Firebase
        const firebaseAppScript = document.createElement('script');
        firebaseAppScript.src = 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js';
        firebaseAppScript.onload = function() {
            console.log('Firebase App SDK åŠ è½½æˆåŠŸ');
            
            const firebaseDbScript = document.createElement('script');
            firebaseDbScript.src = 'https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js';
            firebaseDbScript.onload = function() {
                console.log('Firebase Database SDK åŠ è½½æˆåŠŸ');
                
                const firebaseAuthScript = document.createElement('script');
                firebaseAuthScript.src = 'https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js';
                firebaseAuthScript.onload = function() {
                    console.log('Firebase Auth SDK åŠ è½½æˆåŠŸ');
                    
                    // æ‰€æœ‰ SDK åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ– Firebase
                    try {
                        firebase.initializeApp(firebaseConfig);
                        database = firebase.database();
                        firebaseAvailable = true;
                        console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
                    } catch (error) {
                        console.error('Firebase åˆå§‹åŒ–å¤±è´¥:', error);
                        firebaseAvailable = false;
                    }
                    
                    // ç»§ç»­åˆå§‹åŒ–åº”ç”¨
                    continueInitialization();
                };
                firebaseAuthScript.onerror = function() {
                    console.error('Firebase Auth SDK åŠ è½½å¤±è´¥');
                    firebaseAvailable = false;
                    continueInitialization();
                };
                document.head.appendChild(firebaseAuthScript);
            };
            firebaseDbScript.onerror = function() {
                console.error('Firebase Database SDK åŠ è½½å¤±è´¥');
                firebaseAvailable = false;
                continueInitialization();
            };
            document.head.appendChild(firebaseDbScript);
        };
        firebaseAppScript.onerror = function() {
            console.error('Firebase App SDK åŠ è½½å¤±è´¥');
            firebaseAvailable = false;
            continueInitialization();
        };
        document.head.appendChild(firebaseAppScript);
        
        // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ 5 ç§’å†…æ²¡æœ‰åŠ è½½å®Œæˆï¼Œç»§ç»­åˆå§‹åŒ–
        setTimeout(() => {
            if (!firebaseAvailable) {
                console.log('Firebase SDK åŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                firebaseAvailable = false;
                continueInitialization();
            }
        }, 5000);
        
    } catch (error) {
        console.error('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
        firebaseAvailable = false;
        continueInitialization();
    }
}

function continueInitialization() {
    try {
        showLoading('æ­£åœ¨åˆå§‹åŒ–ç•Œé¢...');
        
        // è®¾ç½® UI çŠ¶æ€
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        
        if (loginContainer) loginContainer.style.display = 'flex';
        if (appContainer) appContainer.style.display = 'none';

        // å¦‚æœ Firebase ä¸å¯ç”¨ï¼Œé»˜è®¤ä½¿ç”¨æœ¬åœ°æ¨¡å¼
        if (!firebaseAvailable) {
            const useLocalCheckbox = document.getElementById('use-local');
            if (useLocalCheckbox) {
                useLocalCheckbox.checked = true;
                useLocalCheckbox.disabled = true;
            }
            useLocalMode = true;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        initializeEventListeners();
        initializeDataManagement();

        // éšè—åŠ è½½ç•Œé¢
        hideLoading();
        console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        
    } catch (error) {
        console.error('ç»§ç»­åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
        // å³ä½¿å‡ºé”™ä¹Ÿè¦éšè—åŠ è½½ç•Œé¢
        hideLoading();
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        const loadingStatus = document.getElementById('loading-status');
        if (loadingStatus) {
            loadingStatus.textContent = 'åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
        }
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
window.addEventListener('DOMContentLoaded', function() {
    console.log('DOM åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨');
    
    // è®¾ç½®åˆå§‹åŒ–è¶…æ—¶
    const initTimeout = setTimeout(() => {
        console.log('åˆå§‹åŒ–è¶…æ—¶ï¼Œå¼ºåˆ¶éšè—åŠ è½½ç•Œé¢');
        hideLoading();
    }, 10000);
    
    try {
        initializeApp();
        clearTimeout(initTimeout);
    } catch (error) {
        console.error('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
        clearTimeout(initTimeout);
        hideLoading();
    }
});

function initializeEventListeners() {
    const loginForm = document.getElementById('login-form');
    if (loginForm) loginForm.addEventListener('submit', handleLogin);

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

    const syncBtn = document.getElementById('sync-btn');
    if (syncBtn) syncBtn.addEventListener('click', handleSmartSync);

    const knowledgeForm = document.getElementById('knowledge-form');
    if (knowledgeForm) knowledgeForm.addEventListener('submit', handleAddKnowledge);

    const subjectSelect = document.getElementById('subject-select');
    if (subjectSelect) subjectSelect.addEventListener('change', handleSubjectChange);

    const filterSubjectSelect = document.getElementById('filter-subject-select');
    if (filterSubjectSelect) filterSubjectSelect.addEventListener('change', handleFilterSubjectChange);

    const clearFilterBtn = document.getElementById('clear-filter-btn');
    if (clearFilterBtn) clearFilterBtn.addEventListener('click', clearFilter);

    const exportTriggerBtn = document.getElementById('export-trigger-btn');
    if (exportTriggerBtn) exportTriggerBtn.addEventListener('click', showExportModal);

    const importTriggerBtn = document.getElementById('import-trigger-btn');
    if (importTriggerBtn) importTriggerBtn.addEventListener('click', showImportModal);

    const closeModalBtn = document.getElementById('close-modal-btn');
    if (closeModalBtn) closeModalBtn.addEventListener('click', hideExportModal);

    const closeImportModalBtn = document.getElementById('close-import-modal-btn');
    if (closeImportModalBtn) closeImportModalBtn.addEventListener('click', hideImportModal);

    const cancelImportBtn = document.getElementById('cancel-import-btn');
    if (cancelImportBtn) cancelImportBtn.addEventListener('click', hideImportModal);

    const confirmImportBtn = document.getElementById('confirm-import-btn');
    if (confirmImportBtn) confirmImportBtn.addEventListener('click', handleImport);

    // ç¼–è¾‘æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬
    const editForm = document.getElementById('edit-form');
    if (editForm) editForm.addEventListener('submit', handleEditKnowledge);

    const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
    if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', hideEditModal);

    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    if (cancelEditBtn) cancelEditBtn.addEventListener('click', hideEditModal);

    const editSubjectSelect = document.getElementById('edit-subject-select');
    if (editSubjectSelect) editSubjectSelect.addEventListener('change', (e) => {
        updateEditFormLabels(e.target.value);
    });

    initializeFileDrop();
    initializeImageUpload();
    initializeImagePreviewModal();
    initializeEditImageUpload();

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideExportModal();
            hideImportModal();
            hideImagePreviewModal();
            hideEditModal();
        }
    });

    window.addEventListener('online', () => {
        isOnline = true;
        showSyncStatus('ç½‘ç»œå·²è¿æ¥', 2000);
        // å¦‚æœæœ‰åŒæ­¥é˜Ÿåˆ—ï¼Œå°è¯•åŒæ­¥
        if (syncQueue.length > 0 && !syncInProgress) {
            processSyncQueue();
        }
    });

    window.addEventListener('offline', () => {
        isOnline = false;
        showSyncStatus('ç½‘ç»œå·²æ–­å¼€', 2000);
    });
}

// æ•°æ®ç®¡ç†åŠŸèƒ½
function initializeDataManagement() {
    const dataManagementBtn = document.getElementById('data-management-btn');
    const dataManagementPanel = document.getElementById('data-management-panel');
    const cleanupBtn = document.getElementById('cleanup-btn');
    const backupBtn = document.getElementById('backup-btn');
    const analyzeBtn = document.getElementById('analyze-btn');
    const cleanLargeBtn = document.getElementById('clean-large-btn');
    const optimizeBtn = document.getElementById('optimize-btn');
    const exportBackupBtn = document.getElementById('export-backup-btn');

    // åˆ‡æ¢æ•°æ®ç®¡ç†é¢æ¿
    if (dataManagementBtn) {
        dataManagementBtn.addEventListener('click', () => {
            if (dataManagementPanel.style.display === 'none') {
                dataManagementPanel.style.display = 'block';
                updateDataStats();
            } else {
                dataManagementPanel.style.display = 'none';
            }
        });
    }

    // æ¸…ç†æŒ‰é’®
    if (cleanupBtn) {
        cleanupBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ‰§è¡Œæ•°æ®æ¸…ç†å—ï¼Ÿè¿™å°†åˆ é™¤å¤§å›¾ç‰‡å’Œæ—§æ•°æ®ã€‚')) {
                performDataCleanup();
            }
        });
    }

    // å¤‡ä»½æŒ‰é’®
    if (backupBtn) {
        backupBtn.addEventListener('click', () => {
            createDataBackup();
        });
    }

    // åˆ†ææŒ‰é’®
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', () => {
            analyzeData();
        });
    }

    // æ¸…ç†å¤§å›¾ç‰‡æŒ‰é’®
    if (cleanLargeBtn) {
        cleanLargeBtn.addEventListener('click', () => {
            cleanLargeImages();
        });
    }

    // ä¼˜åŒ–å­˜å‚¨æŒ‰é’®
    if (optimizeBtn) {
        optimizeBtn.addEventListener('click', () => {
            optimizeStorage();
        });
    }

    // å¯¼å‡ºå¤‡ä»½æŒ‰é’®
    if (exportBackupBtn) {
        exportBackupBtn.addEventListener('click', () => {
            exportDataBackup();
        });
    }

    // å®šæœŸæ›´æ–°æ•°æ®ç»Ÿè®¡
    setInterval(updateDataStats, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
}

// æ›´æ–°æ•°æ®ç»Ÿè®¡ - ä¿®å¤ç‰ˆæœ¬
function updateDataStats() {
    if (!knowledgeData || typeof knowledgeData !== 'object') {
        console.warn('knowledgeData ä¸æ˜¯æœ‰æ•ˆå¯¹è±¡ï¼Œè·³è¿‡ç»Ÿè®¡æ›´æ–°');
        return;
    }

    let totalSize = 0;
    let totalKnowledge = 0;
    let totalImages = 0;
    const totalDates = Object.keys(knowledgeData).length;

    for (const date in knowledgeData) {
        if (!knowledgeData.hasOwnProperty(date)) continue;
        
        const dateData = knowledgeData[date];
        
        // æ£€æŸ¥ dateData æ˜¯å¦ä¸ºæ•°ç»„
        if (!Array.isArray(dateData)) {
            console.warn(`æ—¥æœŸ ${date} çš„æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œè·³è¿‡:`, dateData);
            continue;
        }
        
        totalKnowledge += dateData.length;
        
        dateData.forEach(item => {
            if (item.images && Array.isArray(item.images) && item.images.length > 0) {
                totalImages += item.images.length;
                item.images.forEach(img => {
                    if (img && img.data) {
                        totalSize += img.data.length;
                    }
                });
            }
        });
    }

    // æ›´æ–°æ˜¾ç¤º
    const totalSizeElement = document.getElementById('total-size');
    const totalKnowledgeElement = document.getElementById('total-knowledge');
    const totalImagesElement = document.getElementById('total-images');
    const totalDatesElement = document.getElementById('total-dates');
    const storageProgress = document.getElementById('storage-progress');

    if (totalSizeElement) {
        totalSizeElement.textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
    }
    if (totalKnowledgeElement) {
        totalKnowledgeElement.textContent = totalKnowledge;
    }
    if (totalImagesElement) {
        totalImagesElement.textContent = totalImages;
    }
    if (totalDatesElement) {
        totalDatesElement.textContent = totalDates;
    }

    // æ›´æ–°è¿›åº¦æ¡ï¼ˆå‡è®¾100MBä¸ºæ»¡ï¼‰
    if (storageProgress) {
        const percentage = Math.min((totalSize / (100 * 1024 * 1024)) * 100, 100);
        storageProgress.style.width = percentage + '%';
        
        // æ ¹æ®ä½¿ç”¨é‡æ”¹å˜é¢œè‰²
        if (percentage > 80) {
            storageProgress.style.backgroundColor = '#ef4444';
        } else if (percentage > 60) {
            storageProgress.style.backgroundColor = '#f59e0b';
        } else {
            storageProgress.style.backgroundColor = '#3b82f6';
        }
    }

    // ä¿å­˜ç»Ÿè®¡
    dataManagementStats = {
        totalSize,
        totalKnowledge,
        totalImages,
        totalDates,
        lastAnalysis: new Date().toISOString()
    };
}

// å›¾ç‰‡å‹ç¼©å‡½æ•° - å¤§æ•°æ®ä¼˜åŒ–ç‰ˆ
function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.6) {
    return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
            let { width, height } = img;
            
            // å¦‚æœå›¾ç‰‡å¤ªå¤§ï¼ŒæŒ‰æ¯”ä¾‹ç¼©å°
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // å¡«å……ç™½è‰²èƒŒæ™¯ï¼ˆå¤„ç†PNGé€æ˜åº¦ï¼‰
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);
            
            // ç»˜åˆ¶å›¾ç‰‡
            ctx.drawImage(img, 0, 0, width, height);
            
            // è½¬æ¢ä¸ºJPEGï¼ˆæ›´å°ï¼‰
            canvas.toBlob(resolve, 'image/jpeg', quality);
        };
        
        img.onerror = () => {
            console.warn('å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸæ–‡ä»¶');
            resolve(file);
        };
        
        img.src = URL.createObjectURL(file);
    });
}

// è¾…åŠ©å‡½æ•°ï¼šPromiseåŒ–çš„FileReader
function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// åˆ†ææ•°æ®
function analyzeData() {
    console.log('ğŸ” å¼€å§‹æ•°æ®åˆ†æ...');
    
    if (!knowledgeData || Object.keys(knowledgeData).length === 0) {
        showSyncStatus('æ²¡æœ‰æ•°æ®å¯ä»¥åˆ†æ', 2000);
        return;
    }

    const analysis = {
        totalSize: 0,
        totalKnowledge: 0,
        totalImages: 0,
        totalDates: Object.keys(knowledgeData).length,
        largeImages: [],
        largeDates: [],
        subjectDistribution: {},
        recentActivity: []
    };

    // åˆ†ææ¯ä¸ªæ—¥æœŸ
    for (const date in knowledgeData) {
        if (!knowledgeData.hasOwnProperty(date)) continue;
        
        const dateData = knowledgeData[date];
        
        // æ£€æŸ¥ dateData æ˜¯å¦ä¸ºæ•°ç»„
        if (!Array.isArray(dateData)) {
            console.warn(`æ—¥æœŸ ${date} çš„æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œè·³è¿‡åˆ†æ:`, dateData);
            continue;
        }
        
        const dateSize = JSON.stringify(dateData).length;
        analysis.totalSize += dateSize;
        analysis.totalKnowledge += dateData.length;

        // æ£€æŸ¥å¤§æ—¥æœŸ
        if (dateSize > 5 * 1024 * 1024) { // 5MB
            analysis.largeDates.push({
                date,
                size: dateSize,
                knowledgeCount: dateData.length
            });
        }

        // åˆ†ææ¯ä¸ªçŸ¥è¯†ç‚¹
        dateData.forEach(item => {
            // å­¦ç§‘åˆ†å¸ƒ
            if (item.subject) {
                analysis.subjectDistribution[item.subject] = (analysis.subjectDistribution[item.subject] || 0) + 1;
            }

            // å›¾ç‰‡åˆ†æ
            if (item.images && Array.isArray(item.images) && item.images.length > 0) {
                analysis.totalImages += item.images.length;
                
                item.images.forEach(img => {
                    if (img && img.data) {
                        const imgSize = img.data.length;
                        
                        // æ£€æŸ¥å¤§å›¾ç‰‡
                        if (imgSize > 500 * 1024) { // 500KB
                            analysis.largeImages.push({
                                date,
                                title: item.title,
                                name: img.name,
                                size: imgSize
                            });
                        }
                    }
                });
            }
        });
    }

    // æœ€è¿‘æ´»åŠ¨
    const sortedDates = Object.keys(knowledgeData).sort((a, b) => new Date(b) - new Date(a));
    analysis.recentActivity = sortedDates.slice(0, 7);

    // æ˜¾ç¤ºåˆ†æç»“æœ
    console.log('ğŸ“Š æ•°æ®åˆ†æç»“æœ:');
    console.log(`æ€»æ•°æ®å¤§å°: ${(analysis.totalSize / 1024 / 1024).toFixed(2)}MB`);
    console.log(`çŸ¥è¯†ç‚¹æ€»æ•°: ${analysis.totalKnowledge}`);
    console.log(`å›¾ç‰‡æ€»æ•°: ${analysis.totalImages}`);
    console.log(`å­¦ä¹ å¤©æ•°: ${analysis.totalDates}`);
    
    if (analysis.largeDates.length > 0) {
        console.log(`å¤§æ—¥æœŸæ•°æ® (${analysis.largeDates.length}ä¸ª):`);
        analysis.largeDates.forEach(item => {
            console.log(`  ${item.date}: ${(item.size / 1024 / 1024).toFixed(2)}MB, ${item.knowledgeCount}ä¸ªçŸ¥è¯†ç‚¹`);
        });
    }
    
    if (analysis.largeImages.length > 0) {
        console.log(`å¤§å›¾ç‰‡æ•°æ® (${analysis.largeImages.length}å¼ ):`);
        analysis.largeImages.forEach(item => {
            console.log(`  ${item.date} - ${item.title}: ${(item.size / 1024).toFixed(0)}KB`);
        });
    }

    console.log('å­¦ç§‘åˆ†å¸ƒ:', analysis.subjectDistribution);
    console.log('æœ€è¿‘æ´»åŠ¨:', analysis.recentActivity);

    showSyncStatus(`åˆ†æå®Œæˆ: ${(analysis.totalSize / 1024 / 1024).toFixed(2)}MB, ${analysis.totalKnowledge}ä¸ªçŸ¥è¯†ç‚¹`, 3000);
    
    return analysis;
}

// æ¸…ç†å¤§å›¾ç‰‡
function cleanLargeImages() {
    console.log('ğŸ§¹ å¼€å§‹æ¸…ç†å¤§å›¾ç‰‡...');
    
    let cleanedCount = 0;
    let cleanedSize = 0;
    const maxImageSize = 500 * 1024; // 500KB

    for (const date in knowledgeData) {
        if (!knowledgeData.hasOwnProperty(date)) continue;
        
        const dateData = knowledgeData[date];
        
        // æ£€æŸ¥ dateData æ˜¯å¦ä¸ºæ•°ç»„
        if (!Array.isArray(dateData)) {
            console.warn(`æ—¥æœŸ ${date} çš„æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œè·³è¿‡æ¸…ç†:`, dateData);
            continue;
        }
        
        const originalLength = dateData.length;
        
        knowledgeData[date] = dateData.filter(item => {
            if (item.images && Array.isArray(item.images) && item.images.length > 0) {
                const totalImageSize = item.images.reduce((sum, img) => sum + (img && img.data ? img.data.length : 0), 0);
                
                if (totalImageSize > maxImageSize) {
                    console.log(`æ¸…ç†å¤§å›¾ç‰‡: ${item.title} (${(totalImageSize / 1024).toFixed(0)}KB)`);
                    cleanedCount++;
                    cleanedSize += totalImageSize;
                    item.images = []; // åˆ é™¤å›¾ç‰‡ï¼Œä¿ç•™çŸ¥è¯†ç‚¹
                    return true;
                }
            }
            return true;
        });
        
        // åˆ é™¤ç©ºæ—¥æœŸ
        if (knowledgeData[date].length === 0) {
            delete knowledgeData[date];
            console.log(`åˆ é™¤ç©ºæ—¥æœŸ: ${date}`);
        }
    }

    console.log(`âœ… æ¸…ç†å®Œæˆ: ${cleanedCount}ä¸ªå¤§å›¾ç‰‡, èŠ‚çœ ${(cleanedSize / 1024 / 1024).toFixed(2)}MB`);
    
    // æ›´æ–°æ˜¾ç¤º
    updateDataStats();
    renderKnowledge();
    
    // ä¿å­˜åˆ°æœ¬åœ°
    if (currentUser) {
        localStorage.setItem('knowledge_' + currentUser, JSON.stringify(knowledgeData));
    }
    
    showSyncStatus(`æ¸…ç†å®Œæˆ: ${cleanedCount}ä¸ªå¤§å›¾ç‰‡, èŠ‚çœ ${(cleanedSize / 1024 / 1024).toFixed(2)}MB`, 3000);
    
    return { cleanedCount, cleanedSize };
}

// ä¼˜åŒ–å­˜å‚¨
function optimizeStorage() {
    console.log('âš¡ å¼€å§‹ä¼˜åŒ–å­˜å‚¨...');
    
    let optimizedCount = 0;
    let optimizedSize = 0;
    
    // 1. æ¸…ç†ä¸Šä¼ çš„å›¾ç‰‡
    if (uploadedImages && uploadedImages.length > 3) {
        const removedImages = uploadedImages.splice(3);
        removedImages.forEach(img => {
            optimizedSize += img.data ? img.data.length : 0;
        });
        optimizedCount += removedImages.length;
        console.log(`æ¸…ç†ä¸Šä¼ å›¾ç‰‡: ä¿ç•™3å¼ ï¼Œåˆ é™¤${removedImages.length}å¼ `);
    }
    
    // 2. å‹ç¼©æ‰€æœ‰å›¾ç‰‡
    for (const date in knowledgeData) {
        if (!knowledgeData.hasOwnProperty(date)) continue;
        
        const dateData = knowledgeData[date];
        
        // æ£€æŸ¥ dateData æ˜¯å¦ä¸ºæ•°ç»„
        if (!Array.isArray(dateData)) {
            console.warn(`æ—¥æœŸ ${date} çš„æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œè·³è¿‡ä¼˜åŒ–:`, dateData);
            continue;
        }
        
        dateData.forEach(item => {
            if (item.images && Array.isArray(item.images) && item.images.length > 0) {
                item.images.forEach(img => {
                    if (img.data && img.data.length > 200 * 1024) { // 200KBä»¥ä¸Š
                        const originalSize = img.data.length;
                        // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ¿€è¿›çš„å‹ç¼©é€»è¾‘
                        optimizedSize += originalSize - (originalSize * 0.3); // å‡è®¾å‹ç¼©30%
                        optimizedCount++;
                    }
                });
            }
        });
    }
    
    console.log(`âœ… ä¼˜åŒ–å®Œæˆ: ${optimizedCount}ä¸ªé¡¹ç›®, èŠ‚çœ ${(optimizedSize / 1024 / 1024).toFixed(2)}MB`);
    
    // æ›´æ–°æ˜¾ç¤º
    updateDataStats();
    renderKnowledge();
    
    showSyncStatus(`ä¼˜åŒ–å®Œæˆ: ${optimizedCount}ä¸ªé¡¹ç›®, èŠ‚çœ ${(optimizedSize / 1024 / 1024).toFixed(2)}MB`, 3000);
    
    return { optimizedCount, optimizedSize };
}

// åˆ›å»ºæ•°æ®å¤‡ä»½
function createDataBackup() {
    console.log('ğŸ’¾ åˆ›å»ºæ•°æ®å¤‡ä»½...');
    
    if (!knowledgeData || Object.keys(knowledgeData).length === 0) {
        showSyncStatus('æ²¡æœ‰æ•°æ®å¯ä»¥å¤‡ä»½', 2000);
        return;
    }

    const backupData = {
        version: '2.0',
        timestamp: new Date().toISOString(),
        user: currentUser,
        stats: dataManagementStats,
        data: knowledgeData
    };

    const dataStr = JSON.stringify(backupData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `knowledge_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    const backupKey = `backup_${currentUser}_${Date.now()}`;
    localStorage.setItem(backupKey, dataStr);

    console.log(`âœ… å¤‡ä»½å®Œæˆ: ${(dataStr.length / 1024 / 1024).toFixed(2)}MB`);
    console.log(`ğŸ’¾ æœ¬åœ°å¤‡ä»½: ${backupKey}`);
    
    showSyncStatus(`å¤‡ä»½å®Œæˆ: ${(dataStr.length / 1024 / 1024).toFixed(2)}MB`, 3000);
}

// å¯¼å‡ºæ•°æ®å¤‡ä»½
function exportDataBackup() {
    createDataBackup();
}

// æ™ºèƒ½åˆ†æ‰¹åŒæ­¥å‡½æ•° - ä¿®å¤ç‰ˆæœ¬
async function handleSmartSync() {
    if (!currentUser) {
        console.log('âŒ æœªç™»å½•');
        showSyncStatus('æœªç™»å½•', 2000);
        return;
    }
    
    if (useLocalMode || !firebaseAvailable) {
        console.log('â„¹ï¸ å½“å‰åœ¨æœ¬åœ°æ¨¡å¼ï¼Œæ— éœ€åŒæ­¥');
        showSyncStatus('æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼Œæ— éœ€åŒæ­¥', 2000);
        return;
    }
    
    if (!isOnline) {
        console.log('âŒ ç½‘ç»œæœªè¿æ¥');
        showSyncStatus('ç½‘ç»œæœªè¿æ¥', 2000);
        return;
    }
    
    if (syncInProgress) {
        console.log('â³ åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™');
        showSyncStatus('åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™', 2000);
        return;
    }
    
    try {
        syncInProgress = true;
        showSyncStatus('æ™ºèƒ½åŒæ­¥åˆ†æ...');
        console.log('ğŸ§  æ™ºèƒ½åŒæ­¥åˆ†æ...');
        
        // ç»Ÿè®¡æ•°æ®
        const totalSize = JSON.stringify(knowledgeData).length;
        const totalDates = Object.keys(knowledgeData).length;
        
        console.log(`ğŸ“Š æ•°æ®åˆ†æ:`);
        console.log(`   æ€»å¤§å°: ${(totalSize / 1024 / 1024).toFixed(2)}MB`);
        console.log(`   æ—¥æœŸæ•°é‡: ${totalDates}`);
        
        // æ ¹æ®æ•°æ®å¤§å°é€‰æ‹©åŒæ­¥ç­–ç•¥
        if (totalSize < 5 * 1024 * 1024) { // 5MBä»¥ä¸‹ä½¿ç”¨ç›´æ¥åŒæ­¥
            console.log('ğŸ“Š æ•°æ®è¾ƒå°ï¼Œä½¿ç”¨ç›´æ¥åŒæ­¥');
            syncStrategy = 'direct';
            await saveUserKnowledge();
        } else if (totalSize < 20 * 1024 * 1024) { // 5-20MBä½¿ç”¨åˆ†æ‰¹åŒæ­¥
            console.log('ğŸ“Š æ•°æ®ä¸­ç­‰ï¼Œä½¿ç”¨åˆ†æ‰¹åŒæ­¥');
            syncStrategy = 'batch';
            await batchSync();
        } else { // 20MBä»¥ä¸Šä½¿ç”¨åˆ†å±‚å­˜å‚¨
            console.log('ğŸ“Š æ•°æ®å¾ˆå¤§ï¼Œä½¿ç”¨åˆ†å±‚å­˜å‚¨');
            syncStrategy = 'layered';
            await layeredStorageSync();
        }
        
        lastSyncTime = new Date().toISOString();
        
    } catch (error) {
        console.error('æ™ºèƒ½åŒæ­¥å¤±è´¥:', error);
        showSyncStatus('åŒæ­¥å¤±è´¥: ' + error.message, 3000);
        
        // åŒæ­¥å¤±è´¥æ—¶ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
        if (isOnline) {
            syncQueue.push({
                type: 'full',
                timestamp: new Date().toISOString(),
                data: JSON.parse(JSON.stringify(knowledgeData))
            });
            console.log('å·²æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œå°†åœ¨ä¸‹æ¬¡åŒæ­¥æ—¶é‡è¯•');
        }
    } finally {
        syncInProgress = false;
    }
}

// åˆ†æ‰¹åŒæ­¥å‡½æ•° - ä¿®å¤ç‰ˆæœ¬
async function batchSync() {
    if (!currentUser) return;
    
    try {
        showSyncStatus('åˆ†æ‰¹åŒæ­¥ä¸­...');
        console.log('ğŸš€ å¼€å§‹åˆ†æ‰¹åŒæ­¥...');
        
        // é¦–å…ˆä¿å­˜å…ƒæ•°æ®
        const metadata = {
            totalSize: JSON.stringify(knowledgeData).length,
            totalDates: Object.keys(knowledgeData).length,
            syncStrategy: 'batch',
            lastSyncTime: new Date().toISOString()
        };
        
        await database.ref('metadata/' + currentUser).set(metadata);
        console.log('âœ… å…ƒæ•°æ®åŒæ­¥å®Œæˆ');
        
        const allDates = Object.keys(knowledgeData).sort((a, b) => new Date(b) - new Date(a));
        const totalDates = allDates.length;
        let totalSize = 0;
        let totalKnowledge = 0;
        
        allDates.forEach(date => {
            const dateData = knowledgeData[date];
            if (Array.isArray(dateData)) {
                const dateSize = JSON.stringify(dateData).length;
                totalSize += dateSize;
                totalKnowledge += dateData.length;
            }
        });
        
        console.log(`ğŸ“Š åŒæ­¥ç»Ÿè®¡:`);
        console.log(`   æ—¥æœŸæ•°é‡: ${totalDates}`);
        console.log(`   çŸ¥è¯†ç‚¹æ•°é‡: ${totalKnowledge}`);
        console.log(`   æ€»æ•°æ®å¤§å°: ${(totalSize / 1024 / 1024).toFixed(2)}MB`);
        
        const batchSize = 3; // æ¯æ‰¹3ä¸ªæ—¥æœŸ
        let successBatches = 0;
        let failedBatches = 0;
        let totalBatches = Math.ceil(totalDates / batchSize);
        
        console.log(`ğŸ”„ åˆ†æ‰¹ç­–ç•¥: æ¯æ‰¹${batchSize}ä¸ªæ—¥æœŸï¼Œå…±${totalBatches}æ‰¹æ¬¡`);
        
        for (let i = 0; i < allDates.length; i += batchSize) {
            const batchDates = allDates.slice(i, i + batchSize);
            const batchNumber = Math.floor(i / batchSize) + 1;
            
            console.log(`ğŸ“¦ å¤„ç†æ‰¹æ¬¡ ${batchNumber}/${totalBatches}: ${batchDates.join(', ')}`);
            showSyncStatus(`åŒæ­¥ä¸­... ${batchNumber}/${totalBatches} æ‰¹æ¬¡`);
            
            try {
                const batchData = {};
                let batchHasLargeData = false;
                
                for (const date of batchDates) {
                    const dateData = knowledgeData[date];
                    if (!Array.isArray(dateData)) {
                        console.warn(`æ—¥æœŸ ${date} çš„æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œè·³è¿‡åŒæ­¥:`, dateData);
                        continue;
                    }
                    
                    const dateSize = JSON.stringify(dateData).length;
                    
                    if (dateSize > 12 * 1024 * 1024) { // 12MB
                        console.log(`âš ï¸ æ—¥æœŸ ${date} æ•°æ®è¿‡å¤§(${(dateSize / 1024 / 1024).toFixed(2)}MB)ï¼ŒæŒ‰çŸ¥è¯†ç‚¹æ‹†åˆ†`);
                        batchHasLargeData = true;
                        
                        for (let j = 0; j < dateData.length; j++) {
                            const item = dateData[j];
                            const itemSize = JSON.stringify(item).length;
                            
                            try {
                                await database.ref('knowledge/' + currentUser + '/' + date + '/item_' + j).set(item);
                                console.log(`  âœ… åŒæ­¥ ${date} çŸ¥è¯†ç‚¹ ${j + 1} (${(itemSize / 1024).toFixed(0)}KB)`);
                            } catch (error) {
                                console.error(`  âŒ åŒæ­¥å¤±è´¥ ${date} çŸ¥è¯†ç‚¹ ${j + 1}:`, error);
                                failedBatches++;
                            }
                        }
                    } else {
                        batchData[date] = dateData;
                    }
                }
                
                if (!batchHasLargeData && Object.keys(batchData).length > 0) {
                    const batchStr = JSON.stringify(batchData);
                    const batchSizeBytes = batchStr.length;
                    
                    if (batchSizeBytes > 15 * 1024 * 1024) { // 15MBå®‰å…¨è¾¹ç•Œ
                        console.log(`âš ï¸ æ‰¹æ¬¡ ${batchNumber} æ•°æ®è¿‡å¤§(${(batchSizeBytes / 1024 / 1024).toFixed(2)}MB)ï¼ŒæŒ‰æ—¥æœŸå•ç‹¬åŒæ­¥`);
                        
                        for (const date of batchDates) {
                            try {
                                await database.ref('knowledge/' + currentUser + '/' + date).set(knowledgeData[date]);
                                console.log(`  âœ… å•ç‹¬åŒæ­¥ ${date}`);
                            } catch (error) {
                                console.error(`  âŒ å•ç‹¬åŒæ­¥å¤±è´¥ ${date}:`, error);
                                failedBatches++;
                            }
                        }
                    } else {
                        await database.ref('knowledge/' + currentUser + '/batch_' + batchNumber).set(batchData);
                        console.log(`  âœ… æ‰¹æ¬¡ ${batchNumber} åŒæ­¥å®Œæˆ (${(batchSizeBytes / 1024 / 1024).toFixed(2)}MB)`);
                        successBatches++;
                    }
                }
                
                // æ·»åŠ å»¶è¿Ÿï¼Œé¿å…Firebaseé™åˆ¶
                await new Promise(resolve => setTimeout(resolve, 300));
                
            } catch (error) {
                console.error(`âŒ æ‰¹æ¬¡ ${batchNumber} åŒæ­¥å¤±è´¥:`, error);
                failedBatches++;
            }
        }
        
        console.log(`ğŸ“Š åŒæ­¥å®Œæˆç»Ÿè®¡:`);
        console.log(`   æˆåŠŸæ‰¹æ¬¡: ${successBatches}`);
        console.log(`   å¤±è´¥æ‰¹æ¬¡: ${failedBatches}`);
        console.log(`   æ€»æ‰¹æ¬¡: ${totalBatches}`);
        
        const successRate = ((successBatches / totalBatches) * 100).toFixed(1);
        console.log(`   æˆåŠŸç‡: ${successRate}%`);
        
        if (failedBatches === 0) {
            console.log('ğŸ‰ æ‰€æœ‰æ‰¹æ¬¡åŒæ­¥æˆåŠŸï¼');
            showSyncStatus(`åˆ†æ‰¹åŒæ­¥å®Œæˆ: ${successBatches}/${totalBatches} æ‰¹æ¬¡æˆåŠŸ`, 3000);
        } else {
            console.log(`âš ï¸ ${failedBatches} ä¸ªæ‰¹æ¬¡å¤±è´¥`);
            showSyncStatus(`åŒæ­¥å®Œæˆ: ${successBatches}/${totalBatches} æ‰¹æ¬¡æˆåŠŸ`, 3000);
        }
        
    } catch (error) {
        console.error('åˆ†æ‰¹åŒæ­¥å¤±è´¥:', error);
        showSyncStatus('åˆ†æ‰¹åŒæ­¥å¤±è´¥: ' + error.message, 3000);
        throw error;
    }
}

// åˆ†å±‚å­˜å‚¨å‡½æ•° - ä¿®å¤ç‰ˆæœ¬
async function layeredStorageSync() {
    if (!currentUser) return;
    
    try {
        showSyncStatus('åˆ†å±‚å­˜å‚¨åŒæ­¥ä¸­...');
        console.log('ğŸ—‚ï¸ å¼€å§‹åˆ†å±‚å­˜å‚¨...');
        
        // é¦–å…ˆä¿å­˜å…ƒæ•°æ®
        const metadata = {
            totalSize: JSON.stringify(knowledgeData).length,
            totalDates: Object.keys(knowledgeData).length,
            syncStrategy: 'layered',
            lastSyncTime: new Date().toISOString()
        };
        
        await database.ref('metadata/' + currentUser).set(metadata);
        console.log('âœ… å…ƒæ•°æ®åŒæ­¥å®Œæˆ');
        
        const textData = {};
        const imageData = {};
        let totalImageSize = 0;
        let imageCount = 0;
        
        for (const date in knowledgeData) {
            if (!knowledgeData.hasOwnProperty(date)) continue;            const dateData = knowledgeData[date];
            
            // æ£€æŸ¥ dateData æ˜¯å¦ä¸ºæ•°ç»„
            if (!Array.isArray(dateData)) {
                console.warn(`æ—¥æœŸ ${date} çš„æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œè·³è¿‡åˆ†å±‚å­˜å‚¨:`, dateData);
                continue;
            }
            
            textData[date] = [];
            imageData[date] = [];
            
            dateData.forEach((item, index) => {
                const textItem = { ...item };
                delete textItem.images;
                textData[date].push(textItem);
                
                if (item.images && Array.isArray(item.images) && item.images.length > 0) {
                    imageData[date].push({
                        id: item.id,
                        index: index,
                        images: item.images
                    });
                    
                    item.images.forEach(img => {
                        if (img && img.data) {
                            totalImageSize += img.data.length;
                            imageCount++;
                        }
                    });
                }
            });
        }
        
        console.log(`ğŸ“Š åˆ†å±‚ç»Ÿè®¡:`);
        console.log(`   æ–‡æœ¬æ•°æ®: ${(JSON.stringify(textData).length / 1024 / 1024).toFixed(2)}MB`);
        console.log(`   å›¾ç‰‡æ•°æ®: ${(totalImageSize / 1024 / 1024).toFixed(2)}MB (${imageCount}å¼ )`);
        
        // åŒæ­¥æ–‡æœ¬æ•°æ®
        const textSize = JSON.stringify(textData).length;
        if (textSize > 10 * 1024 * 1024) { // 10MB
            console.log('âš ï¸ æ–‡æœ¬æ•°æ®è¿‡å¤§ï¼Œåˆ†æ‰¹åŒæ­¥');
            const textDates = Object.keys(textData);
            for (let i = 0; i < textDates.length; i += 5) {
                const batchDates = textDates.slice(i, i + 5);
                const batchData = {};
                batchDates.forEach(date => {
                    batchData[date] = textData[date];
                });
                
                try {
                    await database.ref('text/' + currentUser + '/batch_' + Math.floor(i/5)).set(batchData);
                    console.log(`âœ… æ–‡æœ¬æ‰¹æ¬¡ ${Math.floor(i/5)+1} åŒæ­¥å®Œæˆ`);
                } catch (error) {
                    console.error(`âŒ æ–‡æœ¬æ‰¹æ¬¡ ${Math.floor(i/5)+1} åŒæ­¥å¤±è´¥:`, error);
                }
            }
        } else {
            await database.ref('text/' + currentUser).set(textData);
            console.log('âœ… æ–‡æœ¬æ•°æ®åŒæ­¥å®Œæˆ');
        }
        
        // åŒæ­¥å›¾ç‰‡æ•°æ®
        const imageDates = Object.keys(imageData);
        for (let i = 0; i < imageDates.length; i++) {
            const date = imageDates[i];
            const dateImageData = imageData[date];
            
            if (dateImageData.length > 0) {
                try {
                    // æ£€æŸ¥å›¾ç‰‡æ•°æ®å¤§å°
                    const dateImageSize = JSON.stringify(dateImageData).length;
                    if (dateImageSize > 5 * 1024 * 1024) { // 5MB
                        console.log(`âš ï¸ ${date} å›¾ç‰‡æ•°æ®è¿‡å¤§ï¼ŒæŒ‰çŸ¥è¯†ç‚¹æ‹†åˆ†`);
                        
                        for (let j = 0; j < dateImageData.length; j++) {
                            const itemImageData = dateImageData[j];
                            try {
                                await database.ref('images/' + currentUser + '/' + date + '/item_' + j).set(itemImageData);
                                console.log(`  âœ… åŒæ­¥ ${date} å›¾ç‰‡ ${j + 1}`);
                            } catch (error) {
                                console.error(`  âŒ åŒæ­¥å¤±è´¥ ${date} å›¾ç‰‡ ${j + 1}:`, error);
                            }
                        }
                    } else {
                        await database.ref('images/' + currentUser + '/' + date).set(dateImageData);
                        console.log(`âœ… å›¾ç‰‡æ•°æ®åŒæ­¥å®Œæˆ: ${date}`);
                    }
                } catch (error) {
                    console.error(`âŒ å›¾ç‰‡æ•°æ®åŒæ­¥å¤±è´¥ ${date}:`, error);
                }
                
                // æ·»åŠ å»¶è¿Ÿï¼Œé¿å…Firebaseé™åˆ¶
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }
        
        console.log('âœ… åˆ†å±‚å­˜å‚¨åŒæ­¥å®Œæˆ');
        showSyncStatus('åˆ†å±‚å­˜å‚¨åŒæ­¥å®Œæˆ', 3000);
        
    } catch (error) {
        console.error('åˆ†å±‚å­˜å‚¨åŒæ­¥å¤±è´¥:', error);
        showSyncStatus('åŒæ­¥å¤±è´¥: ' + error.message, 3000);
        throw error;
    }
}

// å¤„ç†åŒæ­¥é˜Ÿåˆ—
async function processSyncQueue() {
    if (syncQueue.length === 0 || syncInProgress || !isOnline) return;
    
    console.log(`ğŸ”„ å¤„ç†åŒæ­¥é˜Ÿåˆ—ï¼Œå¾…å¤„ç†: ${syncQueue.length} é¡¹`);
    
    syncInProgress = true;
    
    try {
        // å¤„ç†é˜Ÿåˆ—ä¸­çš„é¡¹ç›®
        while (syncQueue.length > 0) {
            const item = syncQueue.shift();
            console.log(`å¤„ç†é˜Ÿåˆ—é¡¹ç›®: ${item.type} (${item.timestamp})`);
            
            if (item.type === 'full') {
                // å®Œæ•´åŒæ­¥
                knowledgeData = item.data;
                await handleSmartSync();
            } else if (item.type === 'incremental') {
                // å¢é‡åŒæ­¥
                await saveUserKnowledge();
            }
            
            // æ·»åŠ å»¶è¿Ÿï¼Œé¿å…Firebaseé™åˆ¶
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        console.log('âœ… åŒæ­¥é˜Ÿåˆ—å¤„ç†å®Œæˆ');
        showSyncStatus('åŒæ­¥é˜Ÿåˆ—å¤„ç†å®Œæˆ', 2000);
        
    } catch (error) {
        console.error('å¤„ç†åŒæ­¥é˜Ÿåˆ—å¤±è´¥:', error);
        showSyncStatus('åŒæ­¥é˜Ÿåˆ—å¤„ç†å¤±è´¥: ' + error.message, 3000);
    } finally {
        syncInProgress = false;
    }
}

// ä¿®å¤æ•°æ®åŠ è½½å‡½æ•° - å¤„ç†åˆ†å±‚å­˜å‚¨å’Œåˆ†æ‰¹åŒæ­¥çš„æ•°æ®
async function loadUserKnowledge() {
    if (!currentUser) return;
    if (useLocalMode || !firebaseAvailable) {
        knowledgeData = JSON.parse(localStorage.getItem('knowledge_' + currentUser) || '{}');
        return;
    }
    try {
        showSyncStatus('åŠ è½½æ•°æ®...');
        console.log('ğŸ“¥ å¼€å§‹åŠ è½½æ•°æ®...');
        
        // é¦–å…ˆæ£€æŸ¥å…ƒæ•°æ®ï¼Œäº†è§£æ•°æ®å­˜å‚¨æ–¹å¼
        const metadataSnapshot = await database.ref('metadata/' + currentUser).once('value');
        const metadata = metadataSnapshot.val();
        
        if (metadata && metadata.syncStrategy) {
            console.log(`ğŸ“‹ æ£€æµ‹åˆ°${metadata.syncStrategy}å­˜å‚¨ç­–ç•¥ï¼Œå¼€å§‹åŠ è½½...`);
            
            if (metadata.syncStrategy === 'layered') {
                // åŠ è½½åˆ†å±‚å­˜å‚¨æ•°æ®
                await loadLayeredData();
            } else if (metadata.syncStrategy === 'batch') {
                // åŠ è½½åˆ†æ‰¹åŒæ­¥æ•°æ®
                await loadBatchData();
            } else {
                // åŠ è½½ç›´æ¥åŒæ­¥æ•°æ®
                await loadDirectData();
            }
        } else {
            // æ²¡æœ‰å…ƒæ•°æ®ï¼Œå°è¯•ç›´æ¥åŠ è½½
            console.log('ğŸ“‹ æœªæ£€æµ‹åˆ°å­˜å‚¨ç­–ç•¥ï¼Œå°è¯•ç›´æ¥åŠ è½½...');
            await loadDirectData();
        }
        
        console.log('âœ… æ•°æ®åŠ è½½å®Œæˆ');
        database.ref('users/' + currentUser + '/lastLogin').set(new Date().toISOString());
        
    } catch (error) {
        console.error('åŠ è½½æ•°æ®é”™è¯¯:', error);
        showSyncStatus('åŠ è½½æ•°æ®å¤±è´¥ï¼Œå°è¯•æœ¬åœ°å¤‡ä»½', 3000);
        
        // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        const localData = localStorage.getItem('knowledge_' + currentUser);
        if (localData) {
            knowledgeData = JSON.parse(localData);
            console.log('âœ… ä»æœ¬åœ°å¤‡ä»½åŠ è½½æˆåŠŸ');
            showSyncStatus('å·²ä»æœ¬åœ°å¤‡ä»½åŠ è½½æ•°æ®', 2000);
        } else {
            knowledgeData = {};
        }
    }
}

// åŠ è½½ç›´æ¥åŒæ­¥æ•°æ®
async function loadDirectData() {
    const knowledgeRef = database.ref('knowledge/' + currentUser);
    const snapshot = await knowledgeRef.once('value');
    const data = snapshot.val();
    
    if (data && typeof data === 'object') {
        // å¤„ç†åˆ†æ‰¹æ•°æ®
        if (Object.keys(data).some(key => key.startsWith('batch_'))) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°åˆ†æ‰¹æ•°æ®ï¼Œæ­£åœ¨åˆå¹¶...');
            knowledgeData = {};
            
            for (const key in data) {
                if (key.startsWith('batch_')) {
                    const batchData = data[key];
                    if (batchData && typeof batchData === 'object') {
                        for (const date in batchData) {
                            if (Array.isArray(batchData[date])) {
                                if (!knowledgeData[date]) {
                                    knowledgeData[date] = [];
                                }
                                knowledgeData[date] = knowledgeData[date].concat(batchData[date]);
                            }
                        }
                    }
                } else if (!key.startsWith('batch_') && !key.startsWith('item_')) {
                    // æ™®é€šæ—¥æœŸæ•°æ®
                    if (Array.isArray(data[key])) {
                        knowledgeData[key] = data[key];
                    }
                }
            }
        } else {
            // æ™®é€šæ•°æ®
            knowledgeData = data;
        }
    } else {
        knowledgeData = {};
    }
}

// åŠ è½½åˆ†æ‰¹åŒæ­¥æ•°æ®
async function loadBatchData() {
    knowledgeData = {};
    
    // åŠ è½½åˆ†æ‰¹æ•°æ®
    const knowledgeRef = database.ref('knowledge/' + currentUser);
    const snapshot = await knowledgeRef.once('value');
    const data = snapshot.val();
    
    if (data && typeof data === 'object') {
        for (const key in data) {
            if (key.startsWith('batch_')) {
                const batchData = data[key];
                if (batchData && typeof batchData === 'object') {
                    for (const date in batchData) {
                        if (Array.isArray(batchData[date])) {
                            if (!knowledgeData[date]) {
                                knowledgeData[date] = [];
                            }
                            knowledgeData[date] = knowledgeData[date].concat(batchData[date]);
                        }
                    }
                }
            } else if (!key.startsWith('item_')) {
                // æ™®é€šæ—¥æœŸæ•°æ®
                if (Array.isArray(data[key])) {
                    knowledgeData[key] = data[key];
                }
            }
        }
    }
    
    // åŠ è½½å•ç‹¬çš„çŸ¥è¯†ç‚¹æ•°æ®ï¼ˆæ‹†åˆ†çš„å¤§æ•°æ®ï¼‰
    const allDates = Object.keys(knowledgeData);
    for (const date of allDates) {
        try {
            const itemSnapshot = await database.ref('knowledge/' + currentUser + '/' + date).once('value');
            const itemData = itemSnapshot.val();
            
            if (itemData && typeof itemData === 'object') {
                const items = [];
                for (const itemKey in itemData) {
                    if (itemKey.startsWith('item_') && itemData[itemKey]) {
                        items.push(itemData[itemKey]);
                    }
                }
                
                if (items.length > 0) {
                    knowledgeData[date] = items;
                }
            }
        } catch (error) {
            console.warn(`åŠ è½½ ${date} çš„å•ç‹¬æ•°æ®å¤±è´¥:`, error);
        }
    }
}

// åŠ è½½åˆ†å±‚å­˜å‚¨æ•°æ®
async function loadLayeredData() {
    knowledgeData = {};
    
    // åŠ è½½æ–‡æœ¬æ•°æ®
    try {
        const textRef = database.ref('text/' + currentUser);
        const textSnapshot = await textRef.once('value');
        const textData = textSnapshot.val();
        
        if (textData && typeof textData === 'object') {
            // å¤„ç†åˆ†æ‰¹æ–‡æœ¬æ•°æ®
            if (Object.keys(textData).some(key => key.startsWith('batch_'))) {
                for (const batchKey in textData) {
                    const batchData = textData[batchKey];
                    if (batchData && typeof batchData === 'object') {
                        for (const date in batchData) {
                            if (Array.isArray(batchData[date])) {
                                knowledgeData[date] = batchData[date];
                            }
                        }
                    }
                }
            } else {
                // æ™®é€šæ–‡æœ¬æ•°æ®
                for (const date in textData) {
                    if (Array.isArray(textData[date])) {
                        knowledgeData[date] = textData[date];
                    }
                }
            }
        }
    } catch (error) {
        console.error('åŠ è½½æ–‡æœ¬æ•°æ®å¤±è´¥:', error);
    }
    
    // åŠ è½½å›¾ç‰‡æ•°æ®å¹¶åˆå¹¶
    try {
        const imagesRef = database.ref('images/' + currentUser);
        const imagesSnapshot = await imagesRef.once('value');
        const imageData = imagesSnapshot.val();
        
        if (imageData && typeof imageData === 'object') {
            for (const date in imageData) {
                const dateImageData = imageData[date];
                
                if (Array.isArray(dateImageData)) {
                    // æ™®é€šå›¾ç‰‡æ•°æ®
                    dateImageData.forEach(itemImageData => {
                        if (itemImageData && itemImageData.id && itemImageData.images) {
                            const knowledgeIndex = knowledgeData[date].findIndex(k => k.id === itemImageData.id);
                            if (knowledgeIndex !== -1) {
                                knowledgeData[date][knowledgeIndex].images = itemImageData.images;
                            }
                        }
                    });
                } else if (typeof dateImageData === 'object') {
                    // å¤„ç†æ‹†åˆ†çš„å›¾ç‰‡æ•°æ®
                    const items = [];
                    for (const itemKey in dateImageData) {
                        if (itemKey.startsWith('item_') && dateImageData[itemKey]) {
                            items.push(dateImageData[itemKey]);
                        }
                    }
                    
                    items.forEach(itemImageData => {
                        if (itemImageData && itemImageData.id && itemImageData.images) {
                            const knowledgeIndex = knowledgeData[date].findIndex(k => k.id === itemImageData.id);
                            if (knowledgeIndex !== -1) {
                                knowledgeData[date][knowledgeIndex].images = itemImageData.images;
                            }
                        }
                    });
                }
            }
        }
    } catch (error) {
        console.error('åŠ è½½å›¾ç‰‡æ•°æ®å¤±è´¥:', error);
    }
}

// åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
function initializeImageUpload() {
    const imageUploadArea = document.getElementById('image-upload-area');
    const imageInput = document.getElementById('image-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const clipboardBtn = document.getElementById('clipboard-btn');
    
    if (!imageUploadArea || !imageInput || !imagePreviewContainer) return;
    
    imageUploadArea.addEventListener('click', () => {
        imageInput.click();
    });
    
    imageInput.addEventListener('change', (e) => {
        handleImageFiles(e.target.files);
    });
    
    imageUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUploadArea.classList.add('dragover');
    });
    
    imageUploadArea.addEventListener('dragleave', () => {
        imageUploadArea.classList.remove('dragover');
    });
    
    imageUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploadArea.classList.remove('dragover');
        handleImageFiles(e.dataTransfer.files);
    });
    
    if (clipboardBtn) {
        clipboardBtn.addEventListener('click', handleClipboardPaste);
    }
    
    document.addEventListener('paste', (e) => {
        const activeElement = document.activeElement;
        const isInUploadArea = imageUploadArea.contains(activeElement);
        const isInKnowledgeForm = document.getElementById('knowledge-form').contains(activeElement);
        
        if ((isInUploadArea || isInKnowledgeForm) && 
            activeElement.tagName !== 'INPUT' && 
            activeElement.tagName !== 'TEXTAREA') {
            e.preventDefault();
            handleClipboardPaste();
        }
    });
}

// åˆå§‹åŒ–ç¼–è¾‘å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
function initializeEditImageUpload() {
    const imageUploadArea = document.getElementById('edit-image-upload-area');
    const imageInput = document.getElementById('edit-image-input');
    const imagePreviewContainer = document.getElementById('edit-image-preview-container');
    const clipboardBtn = document.getElementById('edit-clipboard-btn');
    
    if (!imageUploadArea || !imageInput || !imagePreviewContainer) return;
    
    imageUploadArea.addEventListener('click', () => {
        imageInput.click();
    });
    
    imageInput.addEventListener('change', (e) => {
        handleEditImageFiles(e.target.files);
    });
    
    imageUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUploadArea.classList.add('dragover');
    });
    
    imageUploadArea.addEventListener('dragleave', () => {
        imageUploadArea.classList.remove('dragover');
    });
    
    imageUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploadArea.classList.remove('dragover');
        handleEditImageFiles(e.dataTransfer.files);
    });
    
    if (clipboardBtn) {
        clipboardBtn.addEventListener('click', handleEditClipboardPaste);
    }
    
    document.addEventListener('paste', (e) => {
        const activeElement = document.activeElement;
        const isInUploadArea = imageUploadArea.contains(activeElement);
        const isInEditForm = document.getElementById('edit-form').contains(activeElement);
        
        if ((isInUploadArea || isInEditForm) && 
            activeElement.tagName !== 'INPUT' && 
            activeElement.tagName !== 'TEXTAREA') {
            e.preventDefault();
            handleEditClipboardPaste();
        }
    });
}

// å¤„ç†å‰ªåˆ‡æ¿ç²˜è´´
async function handleClipboardPaste() {
    const clipboardBtn = document.getElementById('clipboard-btn');
    
    try {
        if (!navigator.clipboard) {
            showSyncStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå‰ªåˆ‡æ¿API', 3000);
            return;
        }
        
        if (clipboardBtn) {
            clipboardBtn.disabled = true;
            clipboardBtn.innerHTML = `
                <div class="loading" style="width: 14px; height: 14px; margin-right: 0.25rem;"></div>
                è¯»å–ä¸­...
            `;
        }
        
        const clipboardItems = await navigator.clipboard.read();
        
        for (const clipboardItem of clipboardItems) {
            for (const type of clipboardItem.types) {
                if (type.startsWith('image/')) {
                    const blob = await clipboardItem.getType(type);
                    const file = new File([blob], `clipboard_${Date.now()}.${type.split('/')[1]}`, { type });
                    
                    await handleImageFiles([file]);
                    
                    if (clipboardBtn) {
                        clipboardBtn.disabled = false;
                        clipboardBtn.innerHTML = `
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            ä»å‰ªåˆ‡æ¿ç²˜è´´
                        `;
                    }
                    
                    return;
                }
            }
        }
        
        showSyncStatus('å‰ªåˆ‡æ¿ä¸­æ²¡æœ‰å›¾ç‰‡', 2000);
        
    } catch (error) {
        console.error('è¯»å–å‰ªåˆ‡æ¿å¤±è´¥:', error);
        showSyncStatus('è¯»å–å‰ªåˆ‡æ¿å¤±è´¥: ' + error.message, 3000);
    } finally {
        if (clipboardBtn) {
            clipboardBtn.disabled = false;
            clipboardBtn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                ä»å‰ªåˆ‡æ¿ç²˜è´´
            `;
        }
    }
}

// å¤„ç†ç¼–è¾‘å‰ªåˆ‡æ¿ç²˜è´´
async function handleEditClipboardPaste() {
    const clipboardBtn = document.getElementById('edit-clipboard-btn');
    
    try {
        if (!navigator.clipboard) {
            showSyncStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå‰ªåˆ‡æ¿API', 3000);
            return;
        }
        
        if (clipboardBtn) {
            clipboardBtn.disabled = true;
            clipboardBtn.innerHTML = `
                <div class="loading" style="width: 14px; height: 14px; margin-right: 0.25rem;"></div>
                è¯»å–ä¸­...
            `;
        }
        
        const clipboardItems = await navigator.clipboard.read();
        
        for (const clipboardItem of clipboardItems) {
            for (const type of clipboardItem.types) {
                if (type.startsWith('image/')) {
                    const blob = await clipboardItem.getType(type);
                    const file = new File([blob], `clipboard_${Date.now()}.${type.split('/')[1]}`, { type });
                    
                    await handleEditImageFiles([file]);
                    
                    if (clipboardBtn) {
                        clipboardBtn.disabled = false;
                        clipboardBtn.innerHTML = `
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            ä»å‰ªåˆ‡æ¿ç²˜è´´
                        `;
                    }
                    
                    return;
                }
            }
        }
        
        showSyncStatus('å‰ªåˆ‡æ¿ä¸­æ²¡æœ‰å›¾ç‰‡', 2000);
        
    } catch (error) {
        console.error('è¯»å–å‰ªåˆ‡æ¿å¤±è´¥:', error);
        showSyncStatus('è¯»å–å‰ªåˆ‡æ¿å¤±è´¥: ' + error.message, 3000);
    } finally {
        if (clipboardBtn) {
            clipboardBtn.disabled = false;
            clipboardBtn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                ä»å‰ªåˆ‡æ¿ç²˜è´´
            `;
        }
    }
}

// å¤„ç†å›¾ç‰‡æ–‡ä»¶
async function handleImageFiles(files) {
    const imagePreviewContainer = document.getElementById('image-preview-container');
    if (!imagePreviewContainer) return;
    
    if (uploadedImages.length + files.length > 5) {
        alert('æœ€å¤šåªèƒ½ä¸Šä¼ 5å¼ å›¾ç‰‡');
        return;
    }
    
    showSyncStatus('æ­£åœ¨å¤„ç†å›¾ç‰‡...');
    
    for (let index = 0; index < files.length; index++) {
        const file = files[index];
        console.log(`å¤„ç†ç¬¬ ${index + 1} ä¸ªæ–‡ä»¶:`, {
            name: file.name,
            type: file.type,
            size: (file.size / 1024).toFixed(2) + ' KB'
        });
        
        if (!file.type.match('image.*')) {
            console.error('æ–‡ä»¶ç±»å‹ä¸åŒ¹é…:', file.type);
            showSyncStatus('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 2000);
            continue;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            console.error('æ–‡ä»¶è¿‡å¤§:', file.size);
            showSyncStatus('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 2000);
            continue;
        }
        
        try {
            const compressedBlob = await compressImage(file);
            const compressedFile = new File([compressedBlob], 
                file.name.replace(/\.[^/.]+$/, '.jpg'), 
                { type: 'image/jpeg' });
            
            const compressionRatio = ((file.size - compressedFile.size) / file.size * 100).toFixed(1);
            console.log(`å›¾ç‰‡å‹ç¼©å®Œæˆ: ${(file.size / 1024).toFixed(2)}KB -> ${(compressedFile.size / 1024).toFixed(2)}KB (å‹ç¼© ${compressionRatio}%)`);
            
            const dataURL = await readFileAsDataURL(compressedFile);
            
            const imageData = {
                id: Date.now() + Math.random(),
                name: compressedFile.name,
                data: dataURL
            };
            
            uploadedImages.push(imageData);
            renderImagePreviews();
            
            showSyncStatus(`å›¾ç‰‡å·²æ·»åŠ  (å‹ç¼© ${compressionRatio}%)`, 2000);
            
        } catch (error) {
            console.error('å¤„ç†å›¾ç‰‡å¤±è´¥:', error);
            showSyncStatus('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message, 3000);
        }
    }
    
    setTimeout(() => {
        showSyncStatus('');
    }, 1000);
}

// å¤„ç†ç¼–è¾‘å›¾ç‰‡æ–‡ä»¶
async function handleEditImageFiles(files) {
    const imagePreviewContainer = document.getElementById('edit-image-preview-container');
    if (!imagePreviewContainer) return;
    
    if (editingImages.length + files.length > 5) {
        alert('æœ€å¤šåªèƒ½ä¸Šä¼ 5å¼ å›¾ç‰‡');
        return;    
    }
    
    showSyncStatus('æ­£åœ¨å¤„ç†å›¾ç‰‡...');
    
    for (let index = 0; index < files.length; index++) {
        const file = files[index];
        console.log(`å¤„ç†ç¬¬ ${index + 1} ä¸ªæ–‡ä»¶:`, {
            name: file.name,
            type: file.type,
            size: (file.size / 1024).toFixed(2) + ' KB'
        });
        
        if (!file.type.match('image.*')) {
            console.error('æ–‡ä»¶ç±»å‹ä¸åŒ¹é…:', file.type);
            showSyncStatus('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 2000);
            continue;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            console.error('æ–‡ä»¶è¿‡å¤§:', file.size);
            showSyncStatus('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 2000);
            continue;
        }
        
        try {
            const compressedBlob = await compressImage(file);
            const compressedFile = new File([compressedBlob], 
                file.name.replace(/\.[^/.]+$/, '.jpg'), 
                { type: 'image/jpeg' });
            
            const compressionRatio = ((file.size - compressedFile.size) / file.size * 100).toFixed(1);
            console.log(`å›¾ç‰‡å‹ç¼©å®Œæˆ: ${(file.size / 1024).toFixed(2)}KB -> ${(compressedFile.size / 1024).toFixed(2)}KB (å‹ç¼© ${compressionRatio}%)`);
            
            const dataURL = await readFileAsDataURL(compressedFile);
            
            const imageData = {
                id: Date.now() + Math.random(),
                name: compressedFile.name,
                data: dataURL
            };
            
            editingImages.push(imageData);
            renderEditImagePreviews();
            
            showSyncStatus(`å›¾ç‰‡å·²æ·»åŠ  (å‹ç¼© ${compressionRatio}%)`, 2000);
            
        } catch (error) {
            console.error('å¤„ç†å›¾ç‰‡å¤±è´¥:', error);
            showSyncStatus('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message, 3000);
        }
    }
    
    setTimeout(() => {
        showSyncStatus('');
    }, 1000);
}

// æ¸²æŸ“å›¾ç‰‡é¢„è§ˆ
function renderImagePreviews() {
    const imagePreviewContainer = document.getElementById('image-preview-container');
    if (!imagePreviewContainer) return;
    
    imagePreviewContainer.innerHTML = '';
    
    uploadedImages.forEach(image => {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview';
        previewDiv.dataset.imageId = image.id;
        
        const img = document.createElement('img');
        img.src = image.data;
        img.alt = image.name;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'image-preview-remove';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => removeImage(image.id);
        
        previewDiv.appendChild(img);
        previewDiv.appendChild(removeBtn);
        imagePreviewContainer.appendChild(previewDiv);
    });
}

// æ¸²æŸ“ç¼–è¾‘å›¾ç‰‡é¢„è§ˆ
function renderEditImagePreviews() {
    const imagePreviewContainer = document.getElementById('edit-image-preview-container');
    if (!imagePreviewContainer) return;
    
    imagePreviewContainer.innerHTML = '';
    
    editingImages.forEach(image => {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview';
        previewDiv.dataset.imageId = image.id;
        
        const img = document.createElement('img');
        img.src = image.data;
        img.alt = image.name;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'image-preview-remove';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => removeEditImage(image.id);
        
        previewDiv.appendChild(img);
        previewDiv.appendChild(removeBtn);
        imagePreviewContainer.appendChild(previewDiv);
    });
}

// ç§»é™¤å›¾ç‰‡
function removeImage(imageId) {
    uploadedImages = uploadedImages.filter(img => img.id !== imageId);
    renderImagePreviews();
}

// ç§»é™¤ç¼–è¾‘å›¾ç‰‡
function removeEditImage(imageId) {
    editingImages = editingImages.filter(img => img.id !== imageId);
    renderEditImagePreviews();
}

// åˆå§‹åŒ–å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
function initializeImagePreviewModal() {
    const imagePreviewModal = document.getElementById('image-preview-modal');
    const imagePreviewClose = document.getElementById('image-preview-close');
    const imagePreviewPrev = document.getElementById('image-preview-prev');
    const imagePreviewNext = document.getElementById('image-preview-next');
    
    if (!imagePreviewModal) return;
    
    if (imagePreviewClose) {
        imagePreviewClose.addEventListener('click', hideImagePreviewModal);
    }
    
    imagePreviewModal.addEventListener('click', (e) => {
        if (e.target === imagePreviewModal) {
            hideImagePreviewModal();
        }
    });
    
    if (imagePreviewPrev) {
        imagePreviewPrev.addEventListener('click', () => {
            currentPreviewImageIndex = (currentPreviewImageIndex - 1 + currentPreviewImages.length) % currentPreviewImages.length;
            updatePreviewImage();
        });
    }
    
    if (imagePreviewNext) {
        imagePreviewNext.addEventListener('click', () => {
            currentPreviewImageIndex = (currentPreviewImageIndex + 1) % currentPreviewImages.length;
            updatePreviewImage();
        });
    }
    
    document.addEventListener('keydown', (e) => {
        if (!imagePreviewModal.classList.contains('show')) return;
        
        if (e.key === 'ArrowLeft') {
            currentPreviewImageIndex = (currentPreviewImageIndex - 1 + currentPreviewImages.length) % currentPreviewImages.length;
            updatePreviewImage();
        } else if (e.key === 'ArrowRight') {
            currentPreviewImageIndex = (currentPreviewImageIndex + 1) % currentPreviewImages.length;
            updatePreviewImage();
        }
    });
}

// æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
function showImagePreviewModal(images, startIndex = 0) {
    const imagePreviewModal = document.getElementById('image-preview-modal');
    if (!imagePreviewModal || !images || images.length === 0) return;
    
    currentPreviewImages = images;
    currentPreviewImageIndex = startIndex;
    
    updatePreviewImage();
    imagePreviewModal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

// éšè—å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
function hideImagePreviewModal() {
    const imagePreviewModal = document.getElementById('image-preview-modal');
    if (!imagePreviewModal) return;
    
    imagePreviewModal.classList.remove('show');
    document.body.style.overflow = '';
}

// æ›´æ–°é¢„è§ˆå›¾ç‰‡
function updatePreviewImage() {
    const imagePreviewImg = document.getElementById('image-preview-img');
    const imagePreviewCounter = document.getElementById('image-preview-counter');
    const imagePreviewPrev = document.getElementById('image-preview-prev');
    const imagePreviewNext = document.getElementById('image-preview-next');
    
    if (!imagePreviewImg || !currentPreviewImages || currentPreviewImages.length === 0) return;
    
    imagePreviewImg.src = currentPreviewImages[currentPreviewImageIndex];
    
    if (imagePreviewCounter) {
        imagePreviewCounter.textContent = `${currentPreviewImageIndex + 1} / ${currentPreviewImages.length}`;
    }
    
    if (currentPreviewImages.length === 1) {
        if (imagePreviewPrev) imagePreviewPrev.style.display = 'none';
        if (imagePreviewNext) imagePreviewNext.style.display = 'none';
    } else {
        if (imagePreviewPrev) imagePreviewPrev.style.display = 'flex';
        if (imagePreviewNext) imagePreviewNext.style.display = 'flex';
    }
}

// å¤„ç†å­¦ç§‘ç­›é€‰å˜åŒ–
function handleFilterSubjectChange(e) {
    currentFilterSubject = e.target.value;
    renderKnowledge();
}

// æ¸…é™¤ç­›é€‰
function clearFilter() {
    currentFilterSubject = "";
    const filterSubjectSelect = document.getElementById('filter-subject-select');
    if (filterSubjectSelect) filterSubjectSelect.value = "";
    renderKnowledge();
}

// æ ¹æ®å­¦ç§‘æ›´æ–°è¡¨å•æ ‡ç­¾
function handleSubjectChange(e) {
    const subject = e.target.value;
    updateFormLabels(subject);
}

function updateFormLabels(subject) {
    const titleLabel = document.getElementById('title-label');
    const titleInput = document.getElementById('title-input');
    const contentLabel = document.getElementById('content-label');
    const contentInput = document.getElementById('content-input');

    if (subject === 'è‹±è¯­') {
        titleLabel.textContent = 'ä½œæ–‡æ¨¡æ¿ / è¯­å¥';
        titleInput.placeholder = 'ä¾‹å¦‚ï¼šIt is universally acknowledged that...';
        contentLabel.textContent = 'ä¸­æ–‡é‡Šä¹‰ / ä½¿ç”¨åœºæ™¯';
        contentInput.placeholder = 'ä¾‹å¦‚ï¼šä¼—æ‰€å‘¨çŸ¥...ï¼ˆç”¨äºå¼•å‡ºæ™®éè§‚ç‚¹ï¼‰';
    } else {
        titleLabel.textContent = 'çŸ¥è¯†ç‚¹åç§°/é¢˜ç›®';
        titleInput.placeholder = 'ä¾‹å¦‚ï¼šå¿«é€Ÿæ’åºç®—æ³• / æ¯›æ³½ä¸œæ€æƒ³æ´»çš„çµé­‚';
        contentLabel.textContent = 'çŸ¥è¯†ç‚¹å†…å®¹/è§£é¢˜æ€è·¯';
        contentInput.placeholder = 'è¯¦ç»†è®°å½•çŸ¥è¯†ç‚¹ã€å…¬å¼ã€è§£é¢˜æ­¥éª¤æˆ–æ€è·¯...';
    }
}

// ç™»å½•å¤„ç†
async function handleLogin(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const useLocalCheckbox = document.getElementById('use-local');
    
    useLocalMode = useLocalCheckbox.checked || !firebaseAvailable;

    if (!username || !password) {
        alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
    }

    const hashedPassword = hashPassword(password);

    try {
        const loginText = document.getElementById('login-text');
        const loginSpinner = document.getElementById('login-spinner');
        const loginBtn = document.getElementById('login-btn');

        if (loginText) loginText.style.display = 'none';
        if (loginSpinner) loginSpinner.style.display = 'inline-block';
        if (loginBtn) loginBtn.disabled = true;

        showSyncStatus('ç™»å½•ä¸­...');
        console.log(`å°è¯•ç™»å½•ç”¨æˆ·: ${username}, ä½¿ç”¨æœ¬åœ°æ¨¡å¼: ${useLocalMode}`);

        if (useLocalMode) {
            currentUser = username;
            knowledgeData = JSON.parse(localStorage.getItem('knowledge_' + username) || '{}');
            console.log('æœ¬åœ°å­˜å‚¨æ¨¡å¼ç™»å½•æˆåŠŸ');
            showApp();
        } else {
            if (!database) throw new Error('Firebase æœªåˆå§‹åŒ–');
            const userRef = database.ref('users/' + username);
            const snapshot = await userRef.once('value');

            if (snapshot.exists()) {
                const userData = snapshot.val();
                if (userData.password === hashedPassword) {
                    currentUser = username;
                    await loadUserKnowledge();
                    showApp();
                } else {
                    alert('å¯†ç é”™è¯¯');
                }
            } else {
                await userRef.set({
                    password: hashedPassword,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
                currentUser = username;
                knowledgeData = {};
                showApp();
            }
        }
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        if (!useLocalMode) {
            const useLocalFallback = confirm(`äº‘ç«¯ç™»å½•å¤±è´¥: ${error.message}\n\næ˜¯å¦ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼Ÿ\nï¼ˆæ•°æ®å°†ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œæ— æ³•è·¨è®¾å¤‡åŒæ­¥ï¼‰`);
            if (useLocalFallback) {
                useLocalMode = true;
                const useLocalCheckbox = document.getElementById('use-local');
                if (useLocalCheckbox) useLocalCheckbox.checked = true;
                currentUser = username;
                knowledgeData = JSON.parse(localStorage.getItem('knowledge_' + username) || '{}');
                showApp();
            } else {
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } else {
            alert('ç™»å½•å¤±è´¥: ' + error.message);
        }
    } finally {
        const loginText = document.getElementById('login-text');
        const loginSpinner = document.getElementById('login-spinner');
        const loginBtn = document.getElementById('login-btn');
        if (loginText) loginText.style.display = 'inline';
        if (loginSpinner) loginSpinner.style.display = 'none';
        if (loginBtn) loginBtn.disabled = false;
        showSyncStatus('');
    }
}

// é€€å‡ºç™»å½•
function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        currentUser = null;
        knowledgeData = {};
        currentFilterSubject = "";
        
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const useLocalCheckbox = document.getElementById('use-local');
        
        if (loginContainer) loginContainer.style.display = 'flex';
        if (appContainer) appContainer.style.display = 'none';
        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
        if (useLocalCheckbox) useLocalCheckbox.checked = false;
    }
}

// æ˜¾ç¤ºä¸»åº”ç”¨
function showApp() {
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const currentUserSpan = document.getElementById('current-user');
    
    if (loginContainer) loginContainer.style.display = 'none';
    if (appContainer) appContainer.style.display = 'block';
    if (currentUserSpan) {
        currentUserSpan.textContent = currentUser + (useLocalMode || !firebaseAvailable ? ' (æœ¬åœ°æ¨¡å¼)' : '');
    }
    
    // åˆå§‹åŒ–æ•°æ®ç»Ÿè®¡
    updateDataStats();
    renderKnowledge();
}

// ä¿å­˜ç”¨æˆ·æ•°æ®
async function saveUserKnowledge() {
    if (!currentUser) return;
    if (useLocalMode || !firebaseAvailable) {
        localStorage.setItem('knowledge_' + currentUser, JSON.stringify(knowledgeData));
        showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
        return;
    }
    try {
        const syncText = document.getElementById('sync-text');
        const syncSpinner = document.getElementById('sync-spinner');
        if (syncText) syncText.style.display = 'none';
        if (syncSpinner) syncSpinner.style.display = 'inline-block';
        showSyncStatus('ä¿å­˜ä¸­...');
        
        const dataStr = JSON.stringify(knowledgeData);
        const dataSize = dataStr.length;
        console.log('å‡†å¤‡ä¿å­˜æ•°æ®ï¼Œå¤§å°:', (dataSize / 1024 / 1024).toFixed(2) + 'MB');
        
        if (dataSize > 10 * 1024 * 1024) {
            throw new Error('æ•°æ®è¿‡å¤§ï¼ˆ' + (dataSize / 1024 / 1024).toFixed(2) + 'MBï¼‰ï¼Œè¯·å‡å°‘å›¾ç‰‡æ•°é‡æˆ–å¤§å°');
        }
        
        await database.ref('knowledge/' + currentUser).set(knowledgeData);
        showSyncStatus('å·²åŒæ­¥åˆ°äº‘ç«¯', 1500);
    } catch (error) {
        console.error('ä¿å­˜æ•°æ®é”™è¯¯:', error);
        let errorMessage = 'åŒæ­¥å¤±è´¥';
        
        if (error.message.includes('data') || error.message.includes('size')) {
            errorMessage = error.message;
        } else if (error.message.includes('network') || error.message.includes('connection')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
        } else if (error.message.includes('permission')) {
            errorMessage = 'æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•';
        } else {
            errorMessage = 'åŒæ­¥å¤±è´¥: ' + error.message;
        }
        
        showSyncStatus(errorMessage, 3000);
        
        if (confirm('äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œæ˜¯å¦ä¿å­˜åˆ°æœ¬åœ°ï¼Ÿ\n\né”™è¯¯ä¿¡æ¯ï¼š' + errorMessage)) {
            localStorage.setItem('knowledge_' + currentUser, JSON.stringify(knowledgeData));
            showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
        }
    } finally {
        const syncText = document.getElementById('sync-text');
        const syncSpinner = document.getElementById('sync-spinner');
        if (syncText) syncText.style.display = 'inline';
        if (syncSpinner) syncSpinner.style.display = 'none';
    }
}

// æ¸²æŸ“çŸ¥è¯†ç‚¹åˆ—è¡¨
function renderKnowledge() {
    const knowledgeListContainer = document.getElementById('knowledge-list-container');
    if (!knowledgeListContainer) return;
    
    knowledgeListContainer.innerHTML = '';
    const sortedDates = Object.keys(knowledgeData).sort((a, b) => new Date(b) - new Date(a));

    const filteredKnowledgeData = {};
    
    if (currentFilterSubject) {
        sortedDates.forEach(dateStr => {
            const dayKnowledge = knowledgeData[dateStr];
            if (Array.isArray(dayKnowledge)) {
                const filtered = dayKnowledge.filter(k => k.subject === currentFilterSubject);
                if (filtered.length > 0) {
                    filteredKnowledgeData[dateStr] = filtered;
                }
            }
        });
    } else {
        sortedDates.forEach(dateStr => {
            const dayKnowledge = knowledgeData[dateStr];
            if (Array.isArray(dayKnowledge)) {
                filteredKnowledgeData[dateStr] = dayKnowledge;
            }
        });
    }

    const filteredSortedDates = Object.keys(filteredKnowledgeData).sort((a, b) => new Date(b) - new Date(a));

    if (filteredSortedDates.length === 0) {
        knowledgeListContainer.innerHTML = '<div class="card"><p style="text-align: center; color: #64748b;">' + 
            (currentFilterSubject ? `æ²¡æœ‰æ‰¾åˆ° "${currentFilterSubject}" å­¦ç§‘çš„çŸ¥è¯†ç‚¹` : 'è¿˜æ²¡æœ‰è®°å½•ä»»ä½•çŸ¥è¯†ç‚¹ï¼Œå¿«æ¥æ·»åŠ ç¬¬ä¸€ä¸ªå§ï¼') + 
            '</p></div>';
        updateStats();
        return;
    }

    filteredSortedDates.forEach(dateStr => {
        let dayKnowledge = filteredKnowledgeData[dateStr];
        const dateObj = new Date(dateStr + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

        const daySection = document.createElement('div');
        daySection.className = 'card fade-in';

        const dateHeader = document.createElement('h3');
        dateHeader.style.cssText = 'font-size: 1.125rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; margin-bottom: 1rem;';
        dateHeader.textContent = `${formattedDate} (${dayKnowledge.length} ä¸ªçŸ¥è¯†ç‚¹)`;
        daySection.appendChild(dateHeader);

        dayKnowledge.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        dayKnowledge.forEach(knowledge => {
            const knowledgeItem = createKnowledgeItem(knowledge, dateStr);
            daySection.appendChild(knowledgeItem);
        });

        knowledgeListContainer.appendChild(daySection);
    });

    updateStats();
}

// åˆ›å»ºçŸ¥è¯†ç‚¹é¡¹
function createKnowledgeItem(knowledge, dateStr) {
    const knowledgeItem = document.createElement('div');
    knowledgeItem.className = `knowledge-item ${knowledge.mastered ? 'mastered' : ''}`;
    knowledgeItem.dataset.date = dateStr;
    knowledgeItem.dataset.id = knowledge.id;

    const knowledgeHeaderDiv = document.createElement('div');
    knowledgeHeaderDiv.className = 'knowledge-header';

    const knowledgeTitle = document.createElement('h4');
    knowledgeTitle.className = 'knowledge-title';
    knowledgeTitle.innerHTML = `${knowledge.title} <span style="font-size:0.8em; color: #3b82f6; font-weight:500;">[${knowledge.subject}]</span>`;

    const actionButtons = document.createElement('div');
    actionButtons.className = 'knowledge-actions';

    const editBtn = document.createElement('button');
    editBtn.className = 'knowledge-btn';
    editBtn.innerHTML = 'âœï¸';
    editBtn.title = 'ç¼–è¾‘';
    editBtn.onclick = () => showEditModal(dateStr, knowledge);

    const masterBtn = document.createElement('button');
    masterBtn.className = 'knowledge-btn';
    masterBtn.innerHTML = knowledge.mastered ? 'âœ…' : 'â—‹';
    masterBtn.title = knowledge.mastered ? 'æ ‡è®°ä¸ºæœªæŒæ¡' : 'æ ‡è®°ä¸ºå·²æŒæ¡';
    masterBtn.onclick = () => toggleMastered(dateStr, knowledge.id);

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'knowledge-btn';
    deleteBtn.innerHTML = 'ğŸ—‘ï¸';
    deleteBtn.title = 'åˆ é™¤';
    deleteBtn.onclick = () => deleteKnowledge(dateStr, knowledge.id);

    actionButtons.appendChild(editBtn);
    actionButtons.appendChild(masterBtn);
    actionButtons.appendChild(deleteBtn);
    knowledgeHeaderDiv.appendChild(knowledgeTitle);
    knowledgeHeaderDiv.appendChild(actionButtons);
    knowledgeItem.appendChild(knowledgeHeaderDiv);

    const contentP = document.createElement('div');
    contentP.className = 'knowledge-content';
    contentP.textContent = knowledge.content;
    knowledgeItem.appendChild(contentP);
    
    if (knowledge.images && knowledge.images.length > 0) {
        const imagesDiv = document.createElement('div');
        imagesDiv.className = 'knowledge-images';
        
        knowledge.images.forEach((image, index) => {
            const imageContainer = document.createElement('div');
            imageContainer.className = 'knowledge-image';
            
            const img = document.createElement('img');
            img.src = image.data;
            img.alt = image.name;
            img.onclick = () => showImagePreviewModal(knowledge.images.map(img => img.data), index);
            
            imageContainer.appendChild(img);
            imagesDiv.appendChild(imageContainer);
        });
        
        knowledgeItem.appendChild(imagesDiv);
    }
    
    const timeP = document.createElement('p');
    timeP.className = 'knowledge-detail';
    const createdAt = new Date(knowledge.createdAt);
    timeP.innerHTML = `<strong>è®°å½•æ—¶é—´:</strong> ${createdAt.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
    knowledgeItem.appendChild(timeP);

    if (knowledge.tags && knowledge.tags.length > 0) {
        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'knowledge-tags';
        knowledge.tags.forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'knowledge-tag';
            tagSpan.textContent = tag;
            tagsDiv.appendChild(tagSpan);
        });
        knowledgeItem.appendChild(tagsDiv);
    }

    return knowledgeItem;
}

// æ›´æ–°ç»Ÿè®¡
function updateStats() {
    let totalKnowledge = 0;
    let masteredKnowledge = 0;
    const today = new Date().toISOString().split('T')[0];
    let todayKnowledgeCount = 0;

    const dates = Object.keys(knowledgeData);
    dates.forEach(date => {
        const dayKnowledge = knowledgeData[date];
        if (!Array.isArray(dayKnowledge)) return;
        
        const filteredKnowledge = currentFilterSubject 
            ? dayKnowledge.filter(k => k.subject === currentFilterSubject)
            : dayKnowledge;
            
        totalKnowledge += filteredKnowledge.length;
        filteredKnowledge.forEach(k => { if (k.mastered) masteredKnowledge++; });
        if (date === today) {
            todayKnowledgeCount = filteredKnowledge.length;
        }
    });

    const totalKnowledgeEl = document.getElementById('total-knowledge');
    const studyDaysEl = document.getElementById('study-days');
    const todayKnowledgeEl = document.getElementById('today-knowledge');
    const masteredKnowledgeEl = document.getElementById('mastered-knowledge');

    if (totalKnowledgeEl) totalKnowledgeEl.textContent = totalKnowledge;
    if (studyDaysEl) studyDaysEl.textContent = dates.length;
    if (todayKnowledgeEl) todayKnowledgeEl.textContent = todayKnowledgeCount;
    if (masteredKnowledgeEl) masteredKnowledgeEl.textContent = masteredKnowledge;
}

// åˆ é™¤çŸ¥è¯†ç‚¹
async function deleteKnowledge(date, id) {
    const idStr = String(id);
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŸ¥è¯†ç‚¹å—ï¼Ÿ')) {
        if (knowledgeData[date] && Array.isArray(knowledgeData[date])) {
            knowledgeData[date] = knowledgeData[date].filter(k => String(k.id) !== idStr);
            if (knowledgeData[date].length === 0) {
                delete knowledgeData[date];
            }
            renderKnowledge();

            if (useLocalMode || !firebaseAvailable) {
                localStorage.setItem('knowledge_' + currentUser, JSON.stringify(knowledgeData));
                showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
            } else {
                if (isOnline) {
                    await handleSmartSync();
                } else {
                    showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
                }
            }
        }
    }
}

// åˆ‡æ¢æŒæ¡çŠ¶æ€
async function toggleMastered(date, id) {
    const idStr = String(id);
    if (knowledgeData[date] && Array.isArray(knowledgeData[date])) {
        const knowledge = knowledgeData[date].find(k => String(k.id) === idStr);
        if (knowledge){
            knowledge.mastered = !knowledge.mastered;
            renderKnowledge();

            if (useLocalMode || !firebaseAvailable) {
                localStorage.setItem('knowledge_' + currentUser, JSON.stringify(knowledgeData));
                showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
            } else {
                if (isOnline) {
                    await handleSmartSync();
                } else {
                    showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
                }
            }
        }
    }
}

// æ·»åŠ çŸ¥è¯†ç‚¹
async function handleAddKnowledge(e) {
    e.preventDefault();

    const subjectSelect = document.getElementById('subject-select');
    const titleInput = document.getElementById('title-input');
    const contentInput = document.getElementById('content-input');
    const tagsInput = document.getElementById('tags-input');
    const knowledgeForm = document.getElementById('knowledge-form');

    const subjectText = subjectSelect.value;
    const titleText = titleInput.value.trim();
    const contentText = contentInput.value.trim();
    const tagsText = tagsInput.value.trim();

    if (!subjectText || !titleText || !contentText) return;

    let totalImageSize = 0;
    uploadedImages.forEach(img => {
        totalImageSize += img.data.length;
    });

    if (totalImageSize > 8 * 1024 * 1024) {
        alert('å›¾ç‰‡æ•°æ®è¿‡å¤§ï¼Œè¯·å‡å°‘å›¾ç‰‡æ•°é‡æˆ–å¤§å°\nå½“å‰å¤§å°: ' + (totalImageSize / 1024 / 1024).toFixed(2) + 'MB\nå»ºè®®: æ¯å¼ å›¾ç‰‡æ§åˆ¶åœ¨1MBä»¥å†…');
        return;
    }

    const today = new Date().toISOString().split('T')[0];
    if (!knowledgeData[today]) {
        knowledgeData[today] = [];
    }

    const tags = tagsText ? tagsText.split(' ').filter(tag => tag.trim() !== '') : [];

    const newKnowledge = {
        id: Date.now(),
        subject: subjectText,
        title: titleText,
        content: contentText,
        tags: tags,
        mastered: false,
        createdAt: new Date().toISOString(),
        images: [...uploadedImages]
    };

    knowledgeData[today].unshift(newKnowledge);

    if (knowledgeForm) knowledgeForm.reset();
    if (titleInput) titleInput.focus();

    updateFormLabels('');

    uploadedImages = [];
    renderImagePreviews();

    renderKnowledge();
    showRandomEncouragement();

    if (useLocalMode || !firebaseAvailable) {
        localStorage.setItem('knowledge_' + currentUser, JSON.stringify(knowledgeData));
        showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
    } else {
        if (isOnline) {
            await handleSmartSync();
        } else {
            showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
        }
    }
}

// æ˜¾ç¤ºéšæœºé¼“åŠ±
function showRandomEncouragement() {
    const encouragements = [
        "åˆæŒæ¡ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œç¦»æˆåŠŸæ›´è¿‘ä¸€æ­¥ï¼",
        "åšæŒå°±æ˜¯èƒœåˆ©ï¼ŒåŠ æ²¹ï¼",
        "ä½ çš„çŸ¥è¯†ä½“ç³»æ­£åœ¨ç¨³æ­¥æ„å»ºï¼",
        "Excellent! Keep it up!",
        "ä»Šæ—¥çš„åŠªåŠ›ï¼Œæ˜¯æ˜æ—¥çš„åº•æ°”ï¼",
        "ä»Šå¤©çš„ä½ æ¯”æ˜¨å¤©æ›´åšå­¦äº†ï¼",
        "Amazing! æ¯ä¸ªçŸ¥è¯†ç‚¹éƒ½æ˜¯ä¸€å—åŸºçŸ³ã€‚",
        "æŒä¹‹ä»¥æ’ï¼Œç»ˆå°†ä¸Šå²¸ï¼",
        "ä½ çš„æ±—æ°´ï¼Œæ—¶é—´çœ‹å¾—è§ï¼",
        "åˆä¸ºæ¢¦æƒ³æ·»ç –åŠ ç“¦äº†ï¼"
    ];

    const toast = document.getElementById('encouragement-toast');
    const encouragementText = document.getElementById('encouragement-text');

    if (toast && encouragementText) {
        const randomIndex = Math.floor(Math.random() * encouragements.length);
        const message = encouragements[randomIndex];
        encouragementText.textContent = message;

        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
}

// æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
function showSyncStatus(message, duration = 2000) {
    const syncStatus = document.getElementById('sync-status');
    const syncStatusText = document.getElementById('sync-status-text');

    if (syncStatus && syncStatusText) {
        syncStatusText.textContent = message;
        syncStatus.classList.add('show');
        setTimeout(() => {
            syncStatus.classList.remove('show');
        }, duration);
    }
}

// å¯†ç å“ˆå¸Œ
function hashPassword(password) {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash.toString();
}

// è·å–æ‰€æœ‰å­¦ç§‘
function getUniqueSubjects() {
    const subjects = new Set();
    for (const date in knowledgeData) {
        const dayKnowledge = knowledgeData[date];
        if (Array.isArray(dayKnowledge)) {
            dayKnowledge.forEach(item => {
                if (item.subject) {
                    subjects.add(item.subject);
                }
            });
        }
    }
    return Array.from(subjects).sort();
}

// å¯¼å‡ºç›¸å…³å‡½æ•°
function showExportModal() {
    const modal = document.getElementById('export-modal');
    const exportOptions = document.getElementById('export-options');

    if (!modal || !exportOptions) return;

    exportOptions.innerHTML = '';

    const exportAllBtn = document.createElement('button');
    exportAllBtn.textContent = 'ğŸ“¦ å¯¼å‡ºå…¨éƒ¨æ•°æ®';
    exportAllBtn.className = 'btn btn-secondary';
    exportAllBtn.style.cssText = 'width: 100%; margin-bottom: 0.5rem; justify-content: flex-start;';
    exportAllBtn.onclick = exportAllData;
    exportOptions.appendChild(exportAllBtn);

    const subjects = getUniqueSubjects();
    if (subjects.length > 0) {
        subjects.forEach(subject => {
            const subjectBtn = document.createElement('button');
            subjectBtn.textContent = `ğŸ“š å¯¼å‡º "${subject}"`;
            subjectBtn.className = 'btn';
            subjectBtn.style.cssText = 'width: 100%; margin-bottom: 0.5rem; justify-content: flex-start; background-color: #f3f4f6; color: #374151;';
            subjectBtn.onclick = () => exportDataForSubject(subject);
            exportOptions.appendChild(subjectBtn);
        });
    } else {
        const noDataMsg = document.createElement('p');
        noDataMsg.style.cssText = 'text-align: center; color: #64748b; padding: 1rem;';
        noDataMsg.textContent = 'æ²¡æœ‰å¯æŒ‰å­¦ç§‘å¯¼å‡ºçš„æ•°æ®ã€‚';
        exportOptions.appendChild(noDataMsg);
    }

    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function hideExportModal() {
    const modal = document.getElementById('export-modal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

function exportDataForSubject(subject) {
    const allKnowledge = [];
    for (const date in knowledgeData) {
        const dayKnowledge = knowledgeData[date];
        if (Array.isArray(dayKnowledge)) {
            dayKnowledge.forEach(knowledge => {
                if (knowledge.subject === subject) {
                    allKnowledge.push({
                        'æ—¥æœŸ': date,
                        'å­¦ç§‘': knowledge.subject,
                        'çŸ¥è¯†ç‚¹åç§°': knowledge.title,
                        'å†…å®¹': knowledge.content,
                        'æ ‡ç­¾': knowledge.tags ? knowledge.tags.join(', ') : '',
                        'æŒæ¡çŠ¶æ€': knowledge.mastered ? 'å·²æŒæ¡' : 'å­¦ä¹ ä¸­',
                        'åˆ›å»ºæ—¶é—´': knowledge.createdAt,
                        'å›¾ç‰‡æ•°é‡': knowledge.images ? knowledge.images.length : 0
                    });
                }
            });
        }
    }

    if (allKnowledge.length === 0) {
        alert(`æ²¡æœ‰æ‰¾åˆ° "${subject}" å­¦ç§‘çš„æ•°æ®å¯ä»¥å¯¼å‡ºï¼`);
        return;
    }

    createAndDownloadExcel(allKnowledge, `è€ƒç ”çŸ¥è¯†ç‚¹_${subject}.xlsx`);
    hideExportModal();
}

function exportAllData() {
    const allKnowledge = [];
    for (const date in knowledgeData) {
        const dayKnowledge = knowledgeData[date];
        if (Array.isArray(dayKnowledge)) {
            dayKnowledge.forEach(knowledge => {
                allKnowledge.push({
                    'æ—¥æœŸ': date,
                    'å­¦ç§‘': knowledge.subject,
                    'çŸ¥è¯†ç‚¹åç§°': knowledge.title,
                    'å†…å®¹': knowledge.content,
                    'æ ‡ç­¾': knowledge.tags ? knowledge.tags.join(', ') : '',
                    'æŒæ¡çŠ¶æ€': knowledge.mastered ? 'å·²æŒæ¡' : 'å­¦ä¹ ä¸­',
                    'åˆ›å»ºæ—¶é—´': knowledge.createdAt,
                    'å›¾ç‰‡æ•°é‡': knowledge.images ? knowledge.images.length : 0
                });
            });
        }
    }

    if (allKnowledge.length === 0) {
        alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
        return;
    }

    const today = new Date().toISOString().split('T')[0];
    createAndDownloadExcel(allKnowledge, `æˆ‘çš„è€ƒç ”çŸ¥è¯†ç‚¹_å…¨éƒ¨_${today}.xlsx`);
    hideExportModal();
}

// å¯¼å…¥ç›¸å…³å‡½æ•°
function showImportModal() {
    const modal = document.getElementById('import-modal');
    if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        resetImportModal();
    }
}

function hideImportModal() {
    const modal = document.getElementById('import-modal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
        resetImportModal();
    }
}

function resetImportModal() {
    const importFileInput = document.getElementById('import-file-input');
    const importPreview = document.getElementById('import-preview');
    const importStatus = document.getElementById('import-status');
    const importError = document.getElementById('import-error');
    const previewTable = document.getElementById('preview-table');

    if (importFileInput) importFileInput.value = '';
    if (importPreview) importPreview.style.display = 'none';
    if (importStatus) importStatus.style.display = 'none';
    if (importError) importError.classList.remove('show');
    if (previewTable) previewTable.innerHTML = '';
    importData = null;
}

function initializeFileDrop() {
    const fileDropZone = document.getElementById('file-drop-zone');
    const importFileInput = document.getElementById('import-file-input');

    if (!fileDropZone || !importFileInput) return;

    fileDropZone.addEventListener('click', () => {
        importFileInput.click();
    });

    fileDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileDropZone.classList.add('dragover');
    });

    fileDropZone.addEventListener('dragleave', () => {
        fileDropZone.classList.remove('dragover');
    });

    fileDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileDropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    importFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
}

function handleFileSelect(file) {
    const importError = document.getElementById('import-error');
    const importStatus = document.getElementById('import-status');

    if (importError) importError.classList.remove('show');

    if (!file.name.match(/\.(xlsx|xls)$/)) {
        if (importError) {
            importError.textContent = 'è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰';
            importError.classList.add('show');
        }
        return;
    }

    if (file.size > 10 * 1024 * 1024) {
        if (importError) {
            importError.textContent = 'æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆ10MBï¼‰';
            importError.classList.add('show');
        }
        return;
    }

    if (importStatus) {
        importStatus.style.display = 'block';
        importStatus.innerHTML = '<div class="loading" style="margin: 0 auto 0.5rem;"></div><p style="font-size: 0.875rem; color: #64748b;">æ­£åœ¨è¯»å–æ–‡ä»¶...</p>';
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            if (typeof XLSX === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = function() { processExcelData(data); };
                script.onerror = function() {
                    if (importStatus) importStatus.style.display = 'none';
                    if (importError) {
                        importError.textContent = 'æ— æ³•åŠ è½½Excelå¤„ç†åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                        importError.classList.add('show');
                    }
                };
                document.head.appendChild(script);
            } else {
                processExcelData(data);
            }
        } catch (error) {
            console.error('è¯»å–æ–‡ä»¶é”™è¯¯:', error);
            if (importStatus) importStatus.style.display = 'none';
            if (importError) {
                importError.textContent = 'è¯»å–æ–‡ä»¶å¤±è´¥: ' + error.message;
                importError.classList.add('show');
            }
        }
    };
    reader.onerror = function() {
        if (importStatus) importStatus.style.display = 'none';
        if (importError) {
            importError.textContent = 'æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•';
            importError.classList.add('show');
        }
    };
    reader.readAsArrayBuffer(file);
}

function processExcelData(data) {
    const importStatus = document.getElementById('import-status');
    const importError = document.getElementById('import-error');

    try {
        if (importStatus) {
            importStatus.innerHTML = '<div class="loading" style="margin: 0 auto 0.5rem;"></div><p style="font-size: 0.875rem; color: #64748b;">æ­£åœ¨è§£æExcelæ–‡ä»¶...</p>';
        }

        const workbook = XLSX.read(data, { type: 'array' });
        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
            throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰å·¥ä½œè¡¨');
        }
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        if (jsonData.length === 0) {
            throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
        }

        const columns = Object.keys(jsonData[0]);
        console.log('Excelåˆ—å:', columns);

        let dateColumn = null;
        let subjectColumn = null;
        let titleColumn = null;

        for (const col of columns) {
            if (col.includes('æ—¥æœŸ') || col.toLowerCase().includes('date')) dateColumn = col;
            if (col.includes('å­¦ç§‘') || col.toLowerCase().includes('subject')) subjectColumn = col;
            if (col.includes('çŸ¥è¯†ç‚¹åç§°') || col.includes('é¢˜ç›®') || col.toLowerCase().includes('title')) titleColumn = col;
        }

        if (!subjectColumn || !titleColumn) {
            throw new Error(`Excelæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œå¿…é¡»åŒ…å«"å­¦ç§‘"å’Œ"çŸ¥è¯†ç‚¹åç§°"åˆ—ã€‚æ‰¾åˆ°çš„åˆ—: ${columns.join(', ')}`);
        }

        const standardizedData = jsonData.map(row => {
            const newRow = {};
            if (dateColumn) {
                newRow['æ—¥æœŸ'] = row[dateColumn];
            } else {
                newRow['æ—¥æœŸ'] = new Date().toISOString().split('T')[0];
            }
            newRow['å­¦ç§‘'] = row[subjectColumn];
            newRow['çŸ¥è¯†ç‚¹åç§°'] = row[titleColumn];

            for (const col of columns) {
                if (col === dateColumn || col === subjectColumn || col === titleColumn) continue;
                if (col.includes('å†…å®¹') || col.toLowerCase().includes('content')) newRow['å†…å®¹'] = row[col];
                else if (col.includes('æ ‡ç­¾') || col.toLowerCase().includes('tag')) newRow['æ ‡ç­¾'] = row[col];
                else if (col.includes('æŒæ¡') || col.toLowerCase().includes('master')) newRow['æŒæ¡çŠ¶æ€'] = row[col];
                else newRow[col] = row[col];
            }
            return newRow;
        });

        importData = standardizedData;
        showImportPreview(standardizedData);
        if (importStatus) importStatus.style.display = 'none';
    } catch (error) {
        console.error('å¤„ç†Excelæ•°æ®é”™è¯¯:', error);
        if (importStatus) importStatus.style.display = 'none';
        if (importError) {
            importError.textContent = 'è§£æExcelæ–‡ä»¶å¤±è´¥: ' + error.message;
            importError.classList.add('show');
        }
    }
}

function showImportPreview(data) {
    const importPreview = document.getElementById('import-preview');
    const previewTable = document.getElementById('preview-table');
    const importSummary = document.getElementById('import-summary');
	    if (!importPreview || !previewTable || !importSummary) return;

    let tableHTML = `
<thead>
<tr>
<th>æ—¥æœŸ</th>
<th>å­¦ç§‘</th>
<th>çŸ¥è¯†ç‚¹åç§°</th>
<th>å†…å®¹</th>
<th>æ ‡ç­¾</th>
<th>æŒæ¡çŠ¶æ€</th>
</tr>
</thead>
<tbody>
`;
    const previewRows = data.slice(0, 10);
    previewRows.forEach(row => {
        tableHTML += `
<tr>
<td>${row['æ—¥æœŸ'] || ''}</td>
<td>${row['å­¦ç§‘'] || ''}</td>
<td>${row['çŸ¥è¯†ç‚¹åç§°'] || ''}</td>
<td>${row['å†…å®¹'] || ''}</td>
<td>${row['æ ‡ç­¾'] || ''}</td>
<td>${row['æŒæ¡çŠ¶æ€'] || ''}</td>
</tr>
`;
    });
    tableHTML += '</tbody>';
    previewTable.innerHTML = tableHTML;

    const importOption = document.querySelector('input[name="import-option"]:checked').value;
    let summaryText = `å…± ${data.length} æ¡æ•°æ®`;
    if (importOption === 'merge') {
        let newKnowledgeCount = 0;
        data.forEach(row => {
            const date = row['æ—¥æœŸ'];
            const title = row['çŸ¥è¯†ç‚¹åç§°'];
            if (date && title) {
                if (!knowledgeData[date] || !knowledgeData[date].some(k => k.title === title)) {
                    newKnowledgeCount++;
                }
            }
        });
        summaryText += `ï¼Œå…¶ä¸­ ${newKnowledgeCount} æ¡ä¸ºæ–°æ•°æ®`;
    }
    importSummary.textContent = summaryText;
    importPreview.style.display = 'block';
}

async function handleImport() {
    if (!importData) return;
    const importOption = document.querySelector('input[name="import-option"]:checked').value;
    const importPreview = document.getElementById('import-preview');
    const importStatus = document.getElementById('import-status');
    const importError = document.getElementById('import-error');

    try {
        if (importPreview) importPreview.style.display = 'none';
        if (importStatus) importStatus.style.display = 'block';

        if (importOption === 'replace') {
            knowledgeData = {};
        }

        let importCount = 0;
        let skipCount = 0;

        for (const row of importData) {
            const date = row['æ—¥æœŸ'];
            const title = row['çŸ¥è¯†ç‚¹åç§°'];
            const subject = row['å­¦ç§‘'];

            if (!date || !title || !subject) continue;

            if (!knowledgeData[date]) {
                knowledgeData[date] = [];
            }

            if (importOption === 'merge') {
                const exists = knowledgeData[date].some(k => k.title === title);
                if (exists) {
                    skipCount++;
                    continue;
                }
            }

            let tags = [];
            if (row['æ ‡ç­¾']) {
                tags = row['æ ‡ç­¾'].split(/[,ï¼Œ;ï¼›\s]+/).filter(tag => tag.trim() !== '');
            }

            const newKnowledge = {
                id: Date.now() + Math.random(),
                subject: subject,
                title: title,
                content: row['å†…å®¹'] || '',
                tags: tags,
                mastered: row['æŒæ¡çŠ¶æ€'] === 'å·²æŒæ¡',
                createdAt: new Date().toISOString(),
                images: []
            };

            knowledgeData[date].push(newKnowledge);
            importCount++;
        }

        await handleSmartSync();

        let message = `æˆåŠŸå¯¼å…¥ ${importCount} æ¡æ•°æ®`;
        if (skipCount > 0) {
            message += `ï¼Œè·³è¿‡ ${skipCount} æ¡é‡å¤æ•°æ®`;
        }
        showSyncStatus(message, 3000);

        renderKnowledge();

        setTimeout(() => { hideImportModal(); }, 1000);

    } catch (error) {
        console.error('å¯¼å…¥æ•°æ®é”™è¯¯:', error);
        if (importError) {
            importError.textContent = 'å¯¼å…¥å¤±è´¥: ' + error.message;
            importError.classList.add('show');
        }
    } finally {
        if (importStatus) importStatus.style.display = 'none';
    }
}

// åˆ›å»ºå¹¶ä¸‹è½½Excelæ–‡ä»¶
function createAndDownloadExcel(data, fileName) {
    if (typeof XLSX === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = function() { createExcelFile(data, fileName); };
        script.onerror = function() { alert('æ— æ³•åŠ è½½Excelå¯¼å‡ºåº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'); };
        document.head.appendChild(script);
    } else {
        createExcelFile(data, fileName);
    }
}

function createExcelFile(data, fileName) {
    try {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "è€ƒç ”çŸ¥è¯†ç‚¹");
        XLSX.writeFile(wb, fileName);
    } catch (error) {
        console.error('åˆ›å»ºExcelæ–‡ä»¶å¤±è´¥:', error);
        alert('åˆ›å»ºExcelæ–‡ä»¶å¤±è´¥: ' + error.message);
    }
}

// ç¼–è¾‘åŠŸèƒ½ç›¸å…³å‡½æ•°
function showEditModal(date, knowledge) {
    const modal = document.getElementById('edit-modal');
    if (!modal) return;

    editingDate = date;
    editingKnowledge = { ...knowledge };
    editingImages = knowledge.images ? [...knowledge.images] : [];

    // å¡«å……è¡¨å•
    const editSubjectSelect = document.getElementById('edit-subject-select');
    const editTitleInput = document.getElementById('edit-title-input');
    const editContentInput = document.getElementById('edit-content-input');
    const editTagsInput = document.getElementById('edit-tags-input');

    if (editSubjectSelect) editSubjectSelect.value = knowledge.subject;
    if (editTitleInput) editTitleInput.value = knowledge.title;
    if (editContentInput) editContentInput.value = knowledge.content;
    if (editTagsInput) editTagsInput.value = knowledge.tags ? knowledge.tags.join(' ') : '';

    // æ›´æ–°è¡¨å•æ ‡ç­¾
    updateEditFormLabels(knowledge.subject);

    // æ¸²æŸ“å›¾ç‰‡é¢„è§ˆ
    renderEditImagePreviews();

    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function hideEditModal() {
    const modal = document.getElementById('edit-modal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }

    // é‡ç½®ç¼–è¾‘çŠ¶æ€
    editingDate = null;
    editingKnowledge = null;
    editingImages = [];
}

function updateEditFormLabels(subject) {
    const titleLabel = document.getElementById('edit-title-label');
    const titleInput = document.getElementById('edit-title-input');
    const contentLabel = document.getElementById('edit-content-label');
    const contentInput = document.getElementById('edit-content-input');

    if (subject === 'è‹±è¯­') {
        titleLabel.textContent = 'ä½œæ–‡æ¨¡æ¿ / è¯­å¥';
        titleInput.placeholder = 'ä¾‹å¦‚ï¼šIt is universally acknowledged that...';
        contentLabel.textContent = 'ä¸­æ–‡é‡Šä¹‰ / ä½¿ç”¨åœºæ™¯';
        contentInput.placeholder = 'ä¾‹å¦‚ï¼šä¼—æ‰€å‘¨çŸ¥...ï¼ˆç”¨äºå¼•å‡ºæ™®éè§‚ç‚¹ï¼‰';
    } else {
        titleLabel.textContent = 'çŸ¥è¯†ç‚¹åç§°/é¢˜ç›®';
        titleInput.placeholder = 'ä¾‹å¦‚ï¼šå¿«é€Ÿæ’åºç®—æ³• / æ¯›æ³½ä¸œæ€æƒ³æ´»çš„çµé­‚';
        contentLabel.textContent = 'çŸ¥è¯†ç‚¹å†…å®¹/è§£é¢˜æ€è·¯';
        contentInput.placeholder = 'è¯¦ç»†è®°å½•çŸ¥è¯†ç‚¹ã€å…¬å¼ã€è§£é¢˜æ­¥éª¤æˆ–æ€è·¯...';
    }
}

async function handleEditKnowledge(e) {
    e.preventDefault();

    const editSubjectSelect = document.getElementById('edit-subject-select');
    const editTitleInput = document.getElementById('edit-title-input');
    const editContentInput = document.getElementById('edit-content-input');
    const editTagsInput = document.getElementById('edit-tags-input');

    const subjectText = editSubjectSelect.value;
    const titleText = editTitleInput.value.trim();
    const contentText = editContentInput.value.trim();
    const tagsText = editTagsInput.value.trim();

    if (!subjectText || !titleText || !contentText) return;

    let totalImageSize = 0;
    editingImages.forEach(img => {
        totalImageSize += img.data.length;
    });

    if (totalImageSize > 8 * 1024 * 1024) {
        alert('å›¾ç‰‡æ•°æ®è¿‡å¤§ï¼Œè¯·å‡å°‘å›¾ç‰‡æ•°é‡æˆ–å¤§å°\nå½“å‰å¤§å°: ' + (totalImageSize / 1024 / 1024).toFixed(2) + 'MB\nå»ºè®®: æ¯å¼ å›¾ç‰‡æ§åˆ¶åœ¨1MBä»¥å†…');
        return;
    }

    // æ›´æ–°çŸ¥è¯†ç‚¹
    if (knowledgeData[editingDate] && Array.isArray(knowledgeData[editingDate])) {
        const knowledgeIndex = knowledgeData[editingDate].findIndex(k => k.id === editingKnowledge.id);
        if (knowledgeIndex !== -1) {
            const tags = tagsText ? tagsText.split(' ').filter(tag => tag.trim() !== '') : [];

            knowledgeData[editingDate][knowledgeIndex] = {
                ...knowledgeData[editingDate][knowledgeIndex],
                subject: subjectText,
                title: titleText,
                content: contentText,
                tags: tags,
                images: [...editingImages],
                updatedAt: new Date().toISOString()
            };

            renderKnowledge();

            if (useLocalMode || !firebaseAvailable) {
                localStorage.setItem('knowledge_' + currentUser, JSON.stringify(knowledgeData));
                showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
            } else {
                if (isOnline) {
                    await handleSmartSync();
                } else {
                    showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
                }
            }

            hideEditModal();
            showSyncStatus('çŸ¥è¯†ç‚¹å·²æ›´æ–°', 2000);
        }
    }
}

// æ‰§è¡Œæ•°æ®æ¸…ç†
function performDataCleanup() {
    console.log('ğŸ§¹ å¼€å§‹æ‰§è¡Œæ•°æ®æ¸…ç†...');
    
    let cleanedDates = 0;
    let cleanedKnowledge = 0;
    let cleanedImages = 0;
    
    for (const date in knowledgeData) {
        if (!knowledgeData.hasOwnProperty(date)) continue;
        
        const dateData = knowledgeData[date];
        
        // æ£€æŸ¥ dateData æ˜¯å¦ä¸ºæ•°ç»„
        if (!Array.isArray(dateData)) {
            console.warn(`æ—¥æœŸ ${date} çš„æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œè·³è¿‡æ¸…ç†:`, dateData);
            delete knowledgeData[date];
            cleanedDates++;
            continue;
        }
        
        const originalLength = dateData.length;
        
        // æ¸…ç†æ— æ•ˆçŸ¥è¯†ç‚¹
        knowledgeData[date] = dateData.filter(item => {
            if (!item || !item.title || !item.subject) {
                console.log(`æ¸…ç†æ— æ•ˆçŸ¥è¯†ç‚¹: ${item ? item.title : 'æœªçŸ¥'}`);
                cleanedKnowledge++;
                return false;
            }
            return true;
        });
        
        // æ¸…ç†æ— æ•ˆå›¾ç‰‡
        knowledgeData[date].forEach(item => {
            if (item.images && Array.isArray(item.images)) {
                const originalImageCount = item.images.length;
                item.images = item.images.filter(img => img && img.data);
                cleanedImages += originalImageCount - item.images.length;
            }
        });
        
        // åˆ é™¤ç©ºæ—¥æœŸ
        if (knowledgeData[date].length === 0) {
            delete knowledgeData[date];
            cleanedDates++;
        }
    }
    
    console.log(`âœ… æ¸…ç†å®Œæˆ: ${cleanedDates}ä¸ªæ—¥æœŸ, ${cleanedKnowledge}ä¸ªçŸ¥è¯†ç‚¹, ${cleanedImages}å¼ å›¾ç‰‡`);
    
    // æ›´æ–°æ˜¾ç¤º
    updateDataStats();
    renderKnowledge();
    
    // ä¿å­˜åˆ°æœ¬åœ°
    if (currentUser) {
        localStorage.setItem('knowledge_' + currentUser, JSON.stringify(knowledgeData));
    }
    
    showSyncStatus(`æ¸…ç†å®Œæˆ: ${cleanedDates}ä¸ªæ—¥æœŸ, ${cleanedKnowledge}ä¸ªçŸ¥è¯†ç‚¹`, 3000);
    
    return { cleanedDates, cleanedKnowledge, cleanedImages };
}

console.log('è€ƒç ”çŸ¥è¯†ç‚¹è®°å½•æœ¬åº”ç”¨åˆå§‹åŒ–å®Œæˆ - å¤§æ•°æ®ç‰ˆ');
</script>

</body>
</html>